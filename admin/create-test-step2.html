<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tạo Đề Thi - Bước 2 - AIGEO</title>
    <link rel="icon" type="image/png" href="https://i.ibb.co/JWTx6WrX/FAVICON.png">
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Be+Vietnam+Pro:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/feather-icons"></script>
    <style>
        :root {
            --primary-teal: #0D9488;
            --primary-emerald: #10B981;
        }
        body { font-family: 'Be Vietnam Pro', sans-serif; background-color: #f1f5f9; }
        .sidebar-link { display: flex; align-items: center; padding: 0.75rem 1rem; border-radius: 0.5rem; transition: background-color 0.2s, color 0.2s; }
        .sidebar-link:hover { background-color: #e2e8f0; color: #0f172a; }
        .sidebar-link.active { 
            background: linear-gradient(90deg, var(--primary-teal), var(--primary-emerald));
            color: white; font-weight: 600; box-shadow: 0 4px 10px rgba(13, 148, 136, 0.2);
        }
        .brand-gradient-text {
            background: linear-gradient(90deg, var(--primary-teal), var(--primary-emerald));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }
        /* ADDED/REFINED FORM-INPUT STYLE for consistency */
        .form-input, .form-select {
            width: 100%; padding: 0.75rem 1rem; margin-top: 0.5rem; border: 1px solid #cbd5e1;
            border-radius: 0.5rem; background-color: #f8fafc; transition: all 0.2s ease-in-out;
        }
        .form-input:focus, .form-select:focus {
            outline: none; background-color: white; border-color: var(--primary-teal);
            box-shadow: 0 0 0 3px rgba(13, 148, 136, 0.15);
        }
        /* END ADDED/REFINED FORM-INPUT STYLE */
        
        .cta-button {
            background: linear-gradient(90deg, var(--primary-teal), var(--primary-emerald));
            transition: all 0.3s ease; box-shadow: 0 4px 15px rgba(13, 148, 136, 0.2);
        }
        .cta-button:hover:not(:disabled) {
            transform: translateY(-2px); box-shadow: 0 6px 20px rgba(13, 148, 136, 0.3);
        }
        .toast { transition: transform 0.3s ease-in-out, opacity 0.3s ease-in-out; transform: translateY(100%); opacity: 0; }
        .toast.show { transform: translateY(0); opacity: 1; }
        .tab-button {
            padding: 0.75rem 1.5rem; border-radius: 0.5rem 0.5rem 0 0; font-weight: 600;
            transition: background-color 0.2s;
        }
        .tab-button.active {
            color: white;
            background: linear-gradient(90deg, var(--primary-teal), var(--primary-emerald));
        }
    </style>
</head>
<body class="flex h-screen">

    <aside class="w-64 bg-white shadow-md flex-shrink-0 flex flex-col">
        <div class="h-16 flex items-center justify-center border-b"><a href="/index.html" class="text-2xl font-bold brand-gradient-text">AIGEO</a></div>
        <nav class="flex-grow p-4 space-y-2">
            <a href="index.html" class="sidebar-link text-slate-600 nav-link"><i data-feather="home"></i>Tổng quan</a>
            <a href="users.html" class="sidebar-link text-slate-600 nav-link"><i data-feather="users"></i>Quản lý người dùng</a>
            <a href="subjects.html" class="sidebar-link text-slate-600 nav-link"><i data-feather="book-open"></i>Quản lý Học liệu</a>
            <a href="questions.html" class="sidebar-link text-slate-600 nav-link"><i data-feather="help-circle"></i>Quản lý Câu hỏi</a>
            <a href="tests.html" class="sidebar-link active"><i data-feather="file-text"></i>Quản lý Đề thi</a>
            <a href="apikeys.html" class="sidebar-link text-slate-600 nav-link"><i data-feather="key"></i>Quản lý API Key</a>
            <a href="settings.html" class="sidebar-link text-slate-600 nav-link"><i data-feather="settings"></i>Cài đặt hệ thống</a>
        </nav>
        <div class="p-4 border-t"><button id="logout-btn" class="w-full sidebar-link text-slate-600 text-left"><i data-feather="log-out"></i>Đăng xuất</button></div>
    </aside>

    <main class="flex-1 flex flex-col overflow-hidden">
        <header class="bg-white shadow-sm h-16 flex items-center justify-between px-6">
            <h1 class="text-xl font-semibold text-slate-800">Tạo Đề Thi (Bước 2/2)</h1>
             <div class="flex items-center">
                <span id="user-name" class="font-semibold text-gray-700 mr-4">Đang tải...</span>
                <img id="user-avatar" class="h-10 w-10 rounded-full object-cover" src="https://placehold.co/40x40/E2E8F0/475569?text=A" alt="Admin Avatar">
            </div>
        </header>
        <div class="flex-1 overflow-x-hidden overflow-y-auto bg-slate-100 p-8">
            <div class="max-w-4xl mx-auto">
                <div class="bg-white rounded-xl shadow-lg p-8">
                    <div class="flex items-center space-x-2 text-sm font-medium text-slate-500 mb-6">
                        <span class="text-green-500">1. Thông tin cơ bản</span>
                        <i data-feather="arrow-right" class="w-4 h-4"></i>
                        <span class="text-slate-800 font-bold">2. Cài đặt chi tiết</span>
                    </div>

                    <form id="create-test-form" class="space-y-6">
                        
                        <div>
                            <label for="test-name" class="block text-sm font-medium text-slate-700">Tên Đề Thi</label>
                            <input type="text" id="test-name" class="form-input" placeholder="Ví dụ: Đề kiểm tra giữa kỳ môn Địa Lý 10" required>
                        </div>

                        <div>
                            <label for="test-subject" class="block text-sm font-medium text-slate-700">Môn Học</label>
                            <select id="test-subject" class="form-select" required>
                                <option value="">--- Chọn Môn Học ---</option>
                            </select>
                        </div>
                        
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <div>
                                <label for="test-duration" class="block text-sm font-medium text-slate-700">Thời lượng (phút)</label>
                                <input type="number" id="test-duration" class="form-input" min="5" max="180" value="90" required>
                            </div>
                            <div>
                                <label for="question-count" class="block text-sm font-medium text-slate-700">Số lượng Câu hỏi</label>
                                <input type="number" id="question-count" class="form-input" min="1" value="50" required>
                            </div>
                        </div>

                        <div class="mt-8">
                            <label class="block text-sm font-medium text-slate-700 mb-2">Phương thức chọn câu hỏi</label>
                            <div class="flex border-b border-slate-300 mb-4">
                                <button type="button" class="tab-button active" data-tab="manual-select">Chọn thủ công</button>
                                <button type="button" class="tab-button bg-slate-200 text-slate-700 hover:bg-slate-300" data-tab="random-select">Chọn ngẫu nhiên</button>
                            </div>
                            
                            <div id="manual-select" class="tab-content bg-slate-50 p-6 rounded-lg border border-slate-200">
                                <p class="text-sm text-slate-600 mb-4">Vui lòng chọn các câu hỏi cụ thể cho đề thi này.</p>
                                <div id="manual-questions-list" class="space-y-3">
                                    <button type="button" id="select-questions-btn" class="bg-slate-700 text-white font-semibold px-4 py-2 rounded-lg hover:bg-slate-800 flex items-center transition-colors text-sm">
                                        <i data-feather="list" class="w-4 h-4 mr-2"></i>Chọn Câu hỏi
                                    </button>
                                </div>
                                <div id="selected-questions-summary" class="mt-4 text-sm text-slate-600">
                                    <span class="font-medium">Số lượng câu đã chọn:</span> <span id="selected-count" class="font-bold text-teal-600">0</span>
                                </div>
                            </div>

                            <div id="random-select" class="tab-content hidden bg-slate-50 p-6 rounded-lg border border-slate-200">
                                <p class="text-sm text-slate-600 mb-4">Hệ thống sẽ chọn ngẫu nhiên dựa trên các tiêu chí sau:</p>
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                    <div>
                                        <label for="random-level" class="block text-sm font-medium text-slate-700">Mức độ Khó</label>
                                        <select id="random-level" class="form-select">
                                            <option value="">Tất cả</option>
                                            <option value="Dễ">Dễ</option>
                                            <option value="Trung bình">Trung bình</option>
                                            <option value="Khó">Khó</option>
                                        </select>
                                    </div>
                                    <div>
                                        <label for="random-topic" class="block text-sm font-medium text-slate-700">Chủ đề/Bài học</label>
                                        <select id="random-topic" class="form-select">
                                            <option value="">Tất cả</option>
                                        </select>
                                    </div>
                                    <div>
                                        <label for="random-count" class="block text-sm font-medium text-slate-700">Số lượng Ngẫu nhiên (tối đa)</label>
                                        <input type="number" id="random-count" class="form-input" min="1" value="50">
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="mt-8 pt-6 border-t border-slate-200">
                            <h3 class="text-lg font-bold text-slate-800 mb-4">Thời gian Thi</h3>
                            <div class="flex items-center mb-4">
                                <input type="checkbox" id="is-scheduled" class="mr-2 h-4 w-4 text-teal-600 border-gray-300 rounded focus:ring-teal-500">
                                <label for="is-scheduled" class="text-sm font-medium text-slate-700">Lên lịch thi (Bật để kích hoạt thời gian)</label>
                            </div>
                            
                            <div id="schedule-fields" class="grid grid-cols-2 md:grid-cols-4 gap-6 hidden">
                                <div>
                                    <label for="start-date" class="block text-sm font-medium text-slate-700">Ngày Bắt đầu</label>
                                    <input type="date" id="start-date" class="form-input">
                                </div>
                                <div>
                                    <label for="start-time" class="block text-sm font-medium text-slate-700">Giờ Bắt đầu</label>
                                    <input type="time" id="start-time" class="form-input">
                                </div>
                                <div>
                                    <label for="end-date" class="block text-sm font-medium text-slate-700">Ngày Kết thúc</label>
                                    <input type="date" id="end-date" class="form-input">
                                </div>
                                <div>
                                    <label for="end-time" class="block text-sm font-medium text-slate-700">Giờ Kết thúc</label>
                                    <input type="time" id="end-time" class="form-input">
                                </div>
                            </div>
                        </div>

                        <div class="mt-8 pt-6 border-t border-slate-200">
                            <h3 class="text-lg font-bold text-slate-800 mb-4">Cài đặt Quyền truy cập</h3>
                            <div class="space-y-4">
                                <div class="flex items-center">
                                    <input type="checkbox" id="is-public" class="mr-2 h-4 w-4 text-teal-600 border-gray-300 rounded focus:ring-teal-500" checked>
                                    <label for="is-public" class="text-sm font-medium text-slate-700">Hiển thị công khai (Tất cả người dùng đều có thể truy cập)</label>
                                </div>
                                <div class="flex items-center">
                                    <input type="checkbox" id="allow-review" class="mr-2 h-4 w-4 text-teal-600 border-gray-300 rounded focus:ring-teal-500" checked>
                                    <label for="allow-review" class="text-sm font-medium text-slate-700">Cho phép xem lại kết quả và đáp án sau khi nộp bài</label>
                                </div>
                            </div>
                        </div>


                        <div class="mt-8 flex justify-between pt-6 border-t border-slate-200">
                            <button type="button" id="back-step-btn" class="bg-slate-300 text-slate-800 font-semibold px-6 py-3 rounded-lg hover:bg-slate-400 transition-colors">
                                Quay lại Bước 1
                            </button>
                            <button type="submit" id="submit-test-btn" class="cta-button text-white font-semibold px-6 py-3 rounded-lg">
                                Hoàn thành và Tạo Đề Thi
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </main>

    <div id="modal-container"></div>
    <div id="toast-container" class="fixed bottom-5 right-5 z-50 space-y-2"></div>
    
    <script src="../firebase-config.js"></script>
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, setDoc, collection, query, where, getDocs, addDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { generateUniqueId } from '../utils.js'; // Assuming you have a utility file for ID generation

        document.addEventListener('DOMContentLoaded', () => {
            const app = initializeApp(firebaseConfig);
            const auth = getAuth(app);
            const db = getFirestore(app);

            // DOM Elements
            const userNameEl = document.getElementById('user-name');
            const userAvatarEl = document.getElementById('user-avatar');
            const toastContainer = document.getElementById('toast-container');
            const subjectSelect = document.getElementById('test-subject');
            const randomTopicSelect = document.getElementById('random-topic');
            const isScheduledCheckbox = document.getElementById('is-scheduled');
            const scheduleFields = document.getElementById('schedule-fields');
            const form = document.getElementById('create-test-form');
            const backStepBtn = document.getElementById('back-step-btn');
            const submitTestBtn = document.getElementById('submit-test-btn');
            const selectedQuestionsSummary = document.getElementById('selected-questions-summary');
            const selectedCountEl = document.getElementById('selected-count');
            const manualQuestionsList = document.getElementById('manual-questions-list');
            const selectQuestionsBtn = document.getElementById('select-questions-btn');

            let allQuestions = [];
            let currentTestTemplate = {};
            let selectedQuestions = []; // Array of question objects
            let currentUserId = null;

            // Utility functions
            function showToast(message, type = 'success') {
                const toast = document.createElement('div');
                const bgColor = type === 'success' ? 'bg-green-500' : 'bg-red-500';
                toast.className = `toast show ${bgColor} text-white px-4 py-2 rounded-lg shadow-lg`;
                toast.textContent = message;
                toastContainer.appendChild(toast);
                setTimeout(() => {
                    toast.classList.remove('show');
                    toast.addEventListener('transitionend', () => toast.remove());
                }, 3000);
            }

            function getQueryParams() {
                const params = {};
                window.location.search.substring(1).split("&").forEach(pair => {
                    const [key, value] = pair.split("=");
                    params[decodeURIComponent(key)] = decodeURIComponent(value);
                });
                return params;
            }

            function updateSelectedCount() {
                selectedCountEl.textContent = selectedQuestions.length;
                const countInput = document.getElementById('question-count');
                if (selectedQuestions.length > 0) {
                     countInput.value = selectedQuestions.length;
                     countInput.disabled = true;
                } else {
                     countInput.disabled = false;
                }
            }
            
            function saveTemplateToSession() {
                const testTemplate = {
                    name: document.getElementById('test-name').value.trim(),
                    subject_id: subjectSelect.value,
                    duration: parseInt(document.getElementById('test-duration').value),
                    question_count: parseInt(document.getElementById('question-count').value),
                    is_scheduled: isScheduledCheckbox.checked,
                    start_time: document.getElementById('is-scheduled').checked ? new Date(`${document.getElementById('start-date').value}T${document.getElementById('start-time').value}:00`).getTime() : null,
                    end_time: document.getElementById('is-scheduled').checked ? new Date(`${document.getElementById('end-date').value}T${document.getElementById('end-time').value}:00`).getTime() : null,
                    is_public: document.getElementById('is-public').checked,
                    allow_review: document.getElementById('allow-review').checked,
                    question_method: document.querySelector('.tab-button.active').dataset.tab,
                    // Random selection criteria
                    random_level: document.getElementById('random-select').classList.contains('hidden') ? null : document.getElementById('random-level').value || null,
                    random_topic: document.getElementById('random-select').classList.contains('hidden') ? null : document.getElementById('random-topic').value || null,
                    random_count: document.getElementById('random-select').classList.contains('hidden') ? null : parseInt(document.getElementById('random-count').value),
                    // Manual selection
                    selected_questions: selectedQuestions.map(q => q.id)
                };
                sessionStorage.setItem('currentTestTemplate', JSON.stringify(testTemplate));
                return testTemplate;
            }

            // Auth state listener
            onAuthStateChanged(auth, async (user) => {
                 if (user) {
                    currentUserId = user.uid;
                    const docSnap = await getDoc(doc(db, "users", user.uid));
                    if (docSnap.exists() && docSnap.data().role === 'admin') {
                        const userData = docSnap.data();
                        userNameEl.textContent = userData.name || 'Admin';
                        const nameInitial = (userData.name || 'A').charAt(0).toUpperCase();
                        userAvatarEl.src = `https://placehold.co/40x40/DC2626/FFFFFF?text=${nameInitial}`;
                        
                        // Load data and init logic
                        await loadSubjects();
                        await loadQuestions();
                        loadInitialData();
                        initEventListeners();
                    } else { window.location.href = '../auth.html'; }
                 } else { window.location.href = '../auth.html'; }
            });

            async function loadSubjects() {
                try {
                    const subjectsSnapshot = await getDocs(collection(db, "subjects"));
                    subjectSelect.innerHTML = '<option value="">--- Chọn Môn Học ---</option>';
                    const topics = new Set();
                    subjectsSnapshot.forEach(doc => {
                        const subject = doc.data();
                        subjectSelect.innerHTML += `<option value="${doc.id}">${subject.name}</option>`;
                        if (subject.topics) {
                             subject.topics.forEach(topic => topics.add(topic));
                        }
                    });

                    // Populate random topic select
                    randomTopicSelect.innerHTML = '<option value="">Tất cả</option>';
                    topics.forEach(topic => {
                         randomTopicSelect.innerHTML += `<option value="${topic}">${topic}</option>`;
                    });

                } catch (error) {
                    console.error("Error loading subjects:", error);
                    showToast("Lỗi tải danh sách môn học.", "error");
                }
            }

            async function loadQuestions() {
                try {
                    const questionsSnapshot = await getDocs(collection(db, "questions"));
                    allQuestions = questionsSnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                } catch (error) {
                     console.error("Error loading questions:", error);
                }
            }

            function loadInitialData() {
                const savedTemplate = sessionStorage.getItem('currentTestTemplate');
                if (savedTemplate) {
                    currentTestTemplate = JSON.parse(savedTemplate);

                    // Apply basic fields
                    document.getElementById('test-name').value = currentTestTemplate.name || '';
                    document.getElementById('test-duration').value = currentTestTemplate.duration || 90;
                    document.getElementById('question-count').value = currentTestTemplate.question_count || 50;
                    subjectSelect.value = currentTestTemplate.subject_id || '';
                    document.getElementById('is-public').checked = currentTestTemplate.is_public !== false;
                    document.getElementById('allow-review').checked = currentTestTemplate.allow_review !== false;

                    // Apply question method
                    const initialTab = currentTestTemplate.question_method || 'manual-select';
                    document.querySelectorAll('.tab-button').forEach(btn => {
                        btn.classList.remove('active', 'bg-slate-200', 'text-slate-700', 'hover:bg-slate-300');
                        btn.classList.add('bg-slate-200', 'text-slate-700', 'hover:bg-slate-300');
                        if (btn.dataset.tab === initialTab) {
                            btn.classList.add('active');
                            btn.classList.remove('bg-slate-200', 'text-slate-700', 'hover:bg-slate-300');
                        }
                    });
                    document.querySelectorAll('.tab-content').forEach(content => content.classList.add('hidden'));
                    document.getElementById(initialTab).classList.remove('hidden');

                    // Apply random selection criteria
                    if (initialTab === 'random-select') {
                        document.getElementById('random-level').value = currentTestTemplate.random_level || '';
                        document.getElementById('random-topic').value = currentTestTemplate.random_topic || '';
                        document.getElementById('random-count').value = currentTestTemplate.random_count || 50;
                        document.getElementById('question-count').disabled = false; // Enable count for random
                    }

                    // Apply manual selection
                    if (initialTab === 'manual-select' && currentTestTemplate.selected_questions && currentTestTemplate.selected_questions.length > 0) {
                        selectedQuestions = allQuestions.filter(q => currentTestTemplate.selected_questions.includes(q.id));
                        updateSelectedCount();
                    }

                    // Apply schedule
                    isScheduledCheckbox.checked = currentTestTemplate.is_scheduled === true;
                    if (isScheduledCheckbox.checked) {
                        scheduleFields.classList.remove('hidden');
                        if (currentTestTemplate.start_time) {
                            const startTime = new Date(currentTestTemplate.start_time);
                            document.getElementById('start-date').value = startTime.toISOString().substring(0, 10);
                            document.getElementById('start-time').value = startTime.toTimeString().substring(0, 5);
                        }
                        if (currentTestTemplate.end_time) {
                            const endTime = new Date(currentTestTemplate.end_time);
                            document.getElementById('end-date').value = endTime.toISOString().substring(0, 10);
                            document.getElementById('end-time').value = endTime.toTimeString().substring(0, 5);
                        }
                    } else {
                        scheduleFields.classList.add('hidden');
                    }
                }
            }

            function initEventListeners() {
                // Tab switching logic
                document.querySelectorAll('.tab-button').forEach(button => {
                    button.addEventListener('click', (e) => {
                        document.querySelectorAll('.tab-button').forEach(btn => {
                            btn.classList.remove('active');
                            btn.classList.add('bg-slate-200', 'text-slate-700', 'hover:bg-slate-300');
                        });
                        e.target.classList.add('active');
                        e.target.classList.remove('bg-slate-200', 'text-slate-700', 'hover:bg-slate-300');

                        document.querySelectorAll('.tab-content').forEach(content => content.classList.add('hidden'));
                        document.getElementById(e.target.dataset.tab).classList.remove('hidden');
                        
                        // Handle question count input state
                        if (e.target.dataset.tab === 'manual-select') {
                            const countInput = document.getElementById('question-count');
                            if (selectedQuestions.length > 0) {
                                countInput.value = selectedQuestions.length;
                                countInput.disabled = true;
                            } else {
                                countInput.disabled = false;
                            }
                        } else {
                             document.getElementById('question-count').disabled = false;
                        }
                    });
                });

                // Schedule toggle logic
                isScheduledCheckbox.addEventListener('change', () => {
                    if (isScheduledCheckbox.checked) {
                        scheduleFields.classList.remove('hidden');
                        // Set default values if empty
                        if (!document.getElementById('start-date').value) {
                            const now = new Date();
                            const oneHourLater = new Date(now.getTime() + 60 * 60000);
                            document.getElementById('start-date').value = now.toISOString().substring(0, 10);
                            document.getElementById('start-time').value = now.toTimeString().substring(0, 5);
                            document.getElementById('end-date').value = oneHourLater.toISOString().substring(0, 10);
                            document.getElementById('end-time').value = oneHourLater.toTimeString().substring(0, 5);
                        }
                    } else {
                        scheduleFields.classList.add('hidden');
                    }
                });
                
                // Back button logic
                backStepBtn.addEventListener('click', () => {
                    // Save current data before going back
                    saveTemplateToSession();
                    window.location.href = 'create-test.html';
                });

                // Question selection modal (simplified example)
                selectQuestionsBtn.addEventListener('click', () => {
                    showToast("Tính năng chọn câu hỏi thủ công đang được phát triển...", "error");
                    // In a real app, this would open a modal/popup to select questions
                });
                
                // Form submission logic
                form.addEventListener('submit', async (e) => {
                    e.preventDefault();
                    
                    const testData = saveTemplateToSession();

                    if (!testData.subject_id) {
                        showToast("Vui lòng chọn Môn Học.", "error");
                        return;
                    }
                    if (testData.question_method === 'manual-select' && selectedQuestions.length === 0) {
                        showToast("Vui lòng chọn câu hỏi thủ công.", "error");
                        return;
                    }
                    if (testData.question_method === 'random-select' && testData.random_count < 1) {
                         showToast("Số lượng câu hỏi ngẫu nhiên phải lớn hơn 0.", "error");
                        return;
                    }
                    if (testData.is_scheduled && (!testData.start_time || !testData.end_time || testData.start_time >= testData.end_time)) {
                        showToast("Thời gian bắt đầu phải trước thời gian kết thúc.", "error");
                        return;
                    }
                    
                    submitTestBtn.disabled = true;
                    submitTestBtn.textContent = 'Đang tạo...';

                    try {
                        let finalQuestionIds = [];
                        let finalQuestionCount = 0;
                        
                        if (testData.question_method === 'manual-select') {
                            finalQuestionIds = testData.selected_questions;
                            finalQuestionCount = finalQuestionIds.length;
                        } else {
                            // Random selection logic
                            let filteredQuestions = allQuestions.filter(q => q.subject_id === testData.subject_id);
                            if (testData.random_level) {
                                filteredQuestions = filteredQuestions.filter(q => q.level === testData.random_level);
                            }
                            if (testData.random_topic) {
                                filteredQuestions = filteredQuestions.filter(q => q.topic === testData.random_topic);
                            }
                            
                            // Shuffle and pick
                            for (let i = filteredQuestions.length - 1; i > 0; i--) {
                                const j = Math.floor(Math.random() * (i + 1));
                                [filteredQuestions[i], filteredQuestions[j]] = [filteredQuestions[j], filteredQuestions[i]];
                            }
                            
                            finalQuestionIds = filteredQuestions.slice(0, testData.random_count || testData.question_count).map(q => q.id);
                            finalQuestionCount = finalQuestionIds.length;
                        }

                        if (finalQuestionCount === 0) {
                            showToast("Không tìm thấy câu hỏi nào thỏa mãn tiêu chí đã chọn.", "error");
                             submitTestBtn.disabled = false;
                             submitTestBtn.textContent = 'Hoàn thành và Tạo Đề Thi';
                            return;
                        }
                        
                        const newTestDoc = {
                            test_id: generateUniqueId(),
                            name: testData.name,
                            subject_id: testData.subject_id,
                            duration: testData.duration,
                            question_count: finalQuestionCount,
                            question_ids: finalQuestionIds,
                            created_by: currentUserId,
                            created_at: Date.now(),
                            is_scheduled: testData.is_scheduled,
                            start_time: testData.is_scheduled ? testData.start_time : null,
                            end_time: testData.is_scheduled ? testData.end_time : null,
                            is_public: testData.is_public,
                            allow_review: testData.allow_review,
                            status: testData.is_scheduled && testData.start_time > Date.now() ? 'scheduled' : 'active',
                            question_method: testData.question_method,
                        };

                        const docRef = await addDoc(collection(db, "tests"), newTestDoc);
                        
                        // Clear session and redirect
                        sessionStorage.removeItem('currentTestTemplate');
                        showToast("Tạo đề thi thành công!", "success");
                        setTimeout(() => {
                            window.location.href = `tests.html`;
                        }, 1500);

                    } catch (error) {
                        console.error("Error creating test:", error);
                        showToast(`Lỗi tạo đề thi: ${error.message}`, "error");
                        submitTestBtn.disabled = false;
                        submitTestBtn.textContent = 'Hoàn thành và Tạo Đề Thi';
                    }
                });

                document.getElementById('logout-btn').addEventListener('click', () => signOut(auth));
            }
        });
    </script>
</body>
</html>