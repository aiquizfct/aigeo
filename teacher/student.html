<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tiến độ Học sinh - AIGEO</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Be+Vietnam+Pro:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/feather-icons"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.css" crossorigin="anonymous">
    <script src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/contrib/auto-render.min.js" crossorigin="anonymous"></script>
    <style>
        :root {
            --primary-teal: #0D9488;
            --primary-emerald: #10B981;
        }
        body { 
            font-family: 'Be Vietnam Pro', sans-serif; 
            background-color: #f1f5f9; 
        }
        .sidebar-link { display: flex; align-items: center; padding: 0.75rem 1rem; border-radius: 0.5rem; transition: background-color 0.2s, color 0.2s; }
        .sidebar-link:hover { background-color: #e2e8f0; color: #0f172a; }
        .sidebar-link.active { 
            background: linear-gradient(90deg, var(--primary-teal), var(--primary-emerald));
            color: white; 
            font-weight: 600; 
            box-shadow: 0 4px 10px rgba(13, 148, 136, 0.2);
        }
        .sidebar-link.active:hover { background: linear-gradient(90deg, var(--primary-teal), var(--primary-emerald)); }
        .sidebar-link svg { margin-right: 0.75rem; }
        .brand-gradient-text {
            background: linear-gradient(90deg, var(--primary-teal), var(--primary-emerald));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }
        .skeleton { background-color: #e2e8f0; border-radius: 0.5rem; animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite; }
        @keyframes pulse { 50% { opacity: .5; } }
        .score {
            font-weight: 600;
            padding: 0.25rem 0.75rem;
            border-radius: 9999px;
            font-size: 0.875rem;
        }
        .score-good { background-color: #dcfce7; color: #166534; }
        .score-avg { background-color: #fef9c3; color: #854d0e; }
        .score-bad { background-color: #fee2e2; color: #991b1b; }

        /* Modal Styles */
        .modal-backdrop { background-color: rgba(0, 0, 0, 0.5); transition: opacity 0.3s ease; }
        .modal-content { transition: transform 0.3s ease, opacity 0.3s ease; transform: translateY(-20px); }
        .prose { max-width: none; }
        .answer-option.correct { background-color: #dcfce7 !important; border-color: #22c55e !important; }
        .answer-option.incorrect { background-color: #fee2e2 !important; border-color: #ef4444 !important; }

    </style>
</head>
<body class="flex h-screen">

    <aside class="w-64 bg-white shadow-md flex-shrink-0 flex flex-col">
        <div class="h-16 flex items-center justify-center border-b"><a href="/index.html" class="text-2xl font-bold brand-gradient-text">AIGEO</a></div>
        <nav class="flex-grow p-4 space-y-2">
            <a href="index.html" class="sidebar-link text-slate-600 nav-link"><i data-feather="home"></i>Bảng điều khiển</a>
            <a href="classrooms.html" class="sidebar-link active"><i data-feather="users"></i>Quản lý Lớp học</a>
            <a href="question-bank.html" class="sidebar-link text-slate-600 nav-link"><i data-feather="database"></i>Ngân hàng câu hỏi</a>
            <a href="tests.html" class="sidebar-link text-slate-600 nav-link"><i data-feather="file-text"></i>Quản lý đề thi</a>
            <a href="account.html" class="sidebar-link text-slate-600 nav-link"><i data-feather="user"></i>Tài khoản</a>
        </nav>
        <div class="p-4 border-t"><button id="logout-btn" class="w-full sidebar-link text-slate-600 text-left"><i data-feather="log-out"></i>Đăng xuất</button></div>
    </aside>

    <main class="flex-1 flex flex-col overflow-hidden">
        <header class="bg-white shadow-sm h-16 flex items-center justify-end px-6">
            <div class="flex items-center">
                <span id="user-name" class="font-semibold text-gray-700 mr-4">Đang tải...</span>
                <img id="user-avatar" class="h-10 w-10 rounded-full object-cover" src="https://placehold.co/40x40/E2E8F0/475569?text=T" alt="Teacher Avatar">
            </div>
        </header>
        <div class="flex-1 overflow-x-hidden overflow-y-auto bg-slate-100 p-8">
            <div class="max-w-7xl mx-auto">
                <div id="page-header" class="flex items-center mb-6">
                    <a href="javascript:history.back()" class="p-2 rounded-md hover:bg-slate-200 mr-4"><i data-feather="arrow-left" class="w-6 h-6 text-slate-600"></i></a>
                    <div>
                        <h1 id="student-name-header" class="text-3xl font-bold text-slate-800">Đang tải...</h1>
                        <p class="mt-1 text-slate-500">Chi tiết tiến độ học tập</p>
                    </div>
                </div>
                
                <div id="stats-container">
                    <!-- Stats and chart will be rendered here -->
                </div>
            </div>
        </div>
    </main>

    <!-- Result Modal -->
    <div id="result-modal" class="fixed inset-0 z-50 items-center justify-center hidden">
        <div id="result-modal-backdrop" class="fixed inset-0 bg-gray-900 bg-opacity-50"></div>
        <div class="bg-white rounded-lg shadow-xl p-6 w-full max-w-4xl modal-content flex flex-col max-h-[90vh] relative z-10">
            <div class="flex justify-between items-center flex-shrink-0 mb-4 border-b pb-2">
                <h2 id="result-modal-title" class="text-xl font-bold text-slate-800">Chi tiết bài làm</h2>
                <button id="result-modal-close-btn" class="p-2 hover:bg-slate-100 rounded-full"><i data-feather="x"></i></button>
            </div>
            <div id="result-modal-content" class="flex-grow overflow-y-auto pr-2 space-y-6">
                <!-- Skeleton loader here initially -->
                <div class="skeleton h-64 w-full"></div>
            </div>
        </div>
    </div>
    
    <script src="../firebase-config.js"></script>
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, collection, onSnapshot, query, where, orderBy, getDocs } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        document.addEventListener('DOMContentLoaded', () => {
            const app = initializeApp(firebaseConfig);
            const auth = getAuth(app);
            const db = getFirestore(app);

            const studentNameHeader = document.getElementById('student-name-header');
            const statsContainer = document.getElementById('stats-container');
            const resultModal = document.getElementById('result-modal');
            const resultModalContent = document.getElementById('result-modal-content');
            const resultModalTitle = document.getElementById('result-modal-title');
            const resultModalCloseBtn = document.getElementById('result-modal-close-btn');
            const resultModalBackdrop = document.getElementById('result-modal-backdrop');
            
            let currentUser = null;
            let currentStudentId = null;
            let progressChart = null;
            let allLessons = [];

            onAuthStateChanged(auth, async (user) => {
                if (user) {
                    currentUser = user;
                    const docSnap = await getDoc(doc(db, "users", user.uid));
                    if (docSnap.exists() && docSnap.data().role === 'teacher') {
                        const userData = docSnap.data();
                        document.getElementById('user-name').textContent = userData.name || 'Giáo viên';
                        document.getElementById('user-avatar').src = `https://placehold.co/40x40/10B981/FFFFFF?text=${(userData.name || 'T').charAt(0)}`;
                        initPage();
                    } else {
                        window.location.href = `../${docSnap.data()?.role || 'auth'}/index.html`;
                    }
                } else {
                    window.location.href = '../auth.html';
                }
            });

            async function initPage() {
                const urlParams = new URLSearchParams(window.location.search);
                currentStudentId = urlParams.get('studentId');
                const studentName = urlParams.get('studentName');

                if (!currentStudentId || !studentName) {
                    document.getElementById('page-header').innerHTML = `<p class="text-red-500 font-semibold">Lỗi: Thiếu thông tin học sinh. Vui lòng thử lại từ trang quản lý lớp.</p>`;
                    return;
                }
                
                studentNameHeader.textContent = studentName;
                const lessonsSnap = await getDocs(collection(db, "lessons"));
                allLessons = lessonsSnap.docs.map(d => ({ id: d.id, ...d.data() }));

                listenForStudentSubmissions();
                setupEventListeners();
            }

            function listenForStudentSubmissions() {
                statsContainer.innerHTML = `<div class="skeleton h-64 w-full"></div>`;
                
                const submissionsQuery = query(
                    collection(db, "submissions"),
                    where("studentId", "==", currentStudentId),
                    orderBy("completedAt", "desc")
                );

                onSnapshot(submissionsQuery, async (snapshot) => {
                    const submissions = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    const teacherClassesQuery = query(collection(db, "classrooms"), where("teacherId", "==", currentUser.uid));
                    const teacherClassesSnap = await getDocs(teacherClassesQuery);
                    const teacherClassIds = teacherClassesSnap.docs.map(doc => doc.id);
                    
                    const filteredSubmissions = submissions.filter(sub => teacherClassIds.includes(sub.classId));
                    
                    if (filteredSubmissions.length === 0) {
                        statsContainer.innerHTML = `<div class="bg-white p-8 rounded-xl text-center text-slate-500"><i data-feather="info" class="w-12 h-12 mx-auto"></i><p class="mt-4">Học sinh này chưa có bài làm nào trong các lớp của bạn.</p></div>`;
                        feather.replace();
                        return;
                    }

                    renderStats(filteredSubmissions);
                }, (error) => {
                    console.error("Error fetching submissions:", error);
                    statsContainer.innerHTML = `<p class="text-red-500">Lỗi khi tải dữ liệu bài làm của học sinh.</p>`;
                });
            }

            function renderStats(submissions) {
                const testsTaken = submissions.length;
                const totalScore = submissions.reduce((sum, r) => sum + (r.score / r.totalQuestions), 0);
                const avgScore = testsTaken > 0 ? ((totalScore / testsTaken) * 10).toFixed(1) : 'N/A';

                let statsHTML = `
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div class="bg-white p-5 rounded-xl shadow-sm">
                            <h4 class="font-semibold text-slate-600">Điểm trung bình</h4>
                            <p class="text-3xl font-bold text-teal-500 mt-1">${avgScore}</p>
                        </div>
                        <div class="bg-white p-5 rounded-xl shadow-sm">
                            <h4 class="font-semibold text-slate-600">Số bài đã làm</h4>
                            <p class="text-3xl font-bold text-blue-500 mt-1">${testsTaken}</p>
                        </div>
                    </div>
                    <div class="mt-8 bg-white p-6 rounded-xl shadow-sm">
                        <h2 class="text-xl font-bold text-slate-800 mb-4">Biểu đồ Tiến độ (10 bài gần nhất)</h2>
                        <div class="relative h-96"><canvas id="progress-chart"></canvas></div>
                    </div>
                    <div class="mt-8">
                        <h2 class="text-xl font-bold text-slate-700 mb-4">Lịch sử làm bài</h2>
                        <div class="bg-white rounded-xl shadow-sm overflow-x-auto">
                            <table class="w-full text-sm text-left text-slate-500">
                                <thead class="text-xs text-slate-700 uppercase bg-slate-50">
                                    <tr>
                                        <th scope="col" class="px-6 py-3">Tên bài làm</th>
                                        <th scope="col" class="px-6 py-3 text-center">Điểm</th>
                                        <th scope="col" class="px-6 py-3 text-center">Ngày làm</th>
                                        <th scope="col" class="px-6 py-3 text-right"></th>
                                    </tr>
                                </thead>
                                <tbody>`;
                
                submissions.forEach(sub => {
                    const score = sub.score;
                    const total = sub.totalQuestions;
                    const percentage = total > 0 ? (score / total) * 100 : 0;
                    let scoreClass = percentage >= 80 ? 'score-good' : (percentage < 50 ? 'score-bad' : 'score-avg');
                    const date = sub.completedAt.toDate().toLocaleDateString('vi-VN');
                    
                    statsHTML += `
                        <tr class="bg-white border-b hover:bg-slate-50">
                            <th scope="row" class="px-6 py-4 font-medium text-slate-900">${sub.testName}</th>
                            <td class="px-6 py-4 text-center"><span class="score ${scoreClass}">${score}/${total}</span></td>
                            <td class="px-6 py-4 text-center">${date}</td>
                            <td class="px-6 py-4 text-right">
                                <button data-submission-id="${sub.id}" class="view-result-btn font-medium text-teal-600 hover:underline">Xem lại</button>
                            </td>
                        </tr>`;
                });

                statsHTML += `</tbody></table></div></div>`;
                statsContainer.innerHTML = statsHTML;
                feather.replace();

                renderProgressChart(submissions.slice(0, 10).reverse());

                document.querySelectorAll('.view-result-btn').forEach(link => {
                    link.addEventListener('click', function(e) {
                        e.preventDefault();
                        showResultModal(this.dataset.submissionId);
                    });
                });
            }

            async function showResultModal(submissionId) {
                resultModal.classList.remove('hidden');
                resultModal.classList.add('flex');
                resultModalContent.innerHTML = `<div class="skeleton h-64 w-full"></div>`;
                
                try {
                    const resultDocRef = doc(db, "submissions", submissionId);
                    const resultSnap = await getDoc(resultDocRef);
                    if (!resultSnap.exists()) throw new Error("Không tìm thấy dữ liệu bài làm.");

                    const resultData = resultSnap.data();
                    const { userAnswers, questionIds, embeddedQuestions } = resultData;
                    
                    resultModalTitle.textContent = `Chi tiết bài làm: ${resultData.testName}`;
                    
                    let questions = [];
                    if (questionIds && questionIds.length > 0) {
                        const fetchedQuestions = [];
                        for (let i = 0; i < questionIds.length; i += 30) {
                            const chunk = questionIds.slice(i, i + 30);
                            const q = query(collection(db, "questions"), where("__name__", "in", chunk));
                            const snapshot = await getDocs(q);
                            snapshot.forEach(doc => fetchedQuestions.push({ id: doc.id, ...doc.data() }));
                        }
                        questions = fetchedQuestions.sort((a, b) => questionIds.indexOf(a.id) - questionIds.indexOf(b.id));
                    } else if (embeddedQuestions && embeddedQuestions.length > 0) {
                        questions = embeddedQuestions;
                    }
                    
                    renderResultDetails(questions, userAnswers);

                } catch(error) {
                    console.error("Error showing result modal:", error);
                    resultModalContent.innerHTML = `<p class="text-red-500">${error.message}</p>`;
                }
            }

            function renderResultDetails(questions, userAnswers) {
                resultModalContent.innerHTML = '';
                questions.forEach((q, index) => {
                    const lesson = allLessons.find(l => l.id === q.lessonId);
                    const userAnswer = userAnswers[q.id];
                    let isCorrect = false;
                    let answerHTML = '';

                    if (q.type === 'multiple_choice') {
                        const originalAnswer = q.shuffledOptions?.find(opt => opt.originalLetter === q.correctAnswer);
                        const selectedOption = q.shuffledOptions?.find((opt, i) => String.fromCharCode(65 + i) === userAnswer);
                        isCorrect = selectedOption?.originalLetter === q.correctAnswer;
                        answerHTML = (q.shuffledOptions || []).map((optionData, i) => {
                            const optionLetter = String.fromCharCode(65 + i);
                            let classes = 'answer-option border p-3 rounded-md mt-2 flex items-start';
                            if(optionData.originalLetter === q.correctAnswer) classes += ' correct';
                            else if (optionLetter === userAnswer && !isCorrect) classes += ' incorrect';
                            return `<div class="${classes}"><span class="font-bold mr-2">${optionLetter}.</span> <div class="prose prose-sm">${optionData.content}</div></div>`;
                        }).join('');
                    } else { // Handle other types if necessary
                         isCorrect = String(userAnswer || "").trim().toLowerCase() === String(q.correctAnswer).trim().toLowerCase();
                         answerHTML = `<div class="mt-4"><p><strong>Đáp án đúng:</strong> <span class="font-mono bg-green-100 text-green-800 px-2 py-1 rounded">${q.correctAnswer}</span></p><p><strong>Câu trả lời của bạn:</strong> <span class="font-mono ${isCorrect ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800'} px-2 py-1 rounded">${userAnswer || '(bỏ trống)'}</span></p></div>`;
                    }
                    
                    const questionCard = document.createElement('div');
                    questionCard.className = 'bg-slate-50 p-4 rounded-xl';
                    questionCard.innerHTML = `
                        <div class="flex justify-between items-start">
                            <div><p class="font-bold text-slate-800">Câu ${index + 1}</p><p class="text-xs text-slate-500 mt-1">Chủ đề: ${lesson ? lesson.name : 'N/A'}</p></div>
                            <span class="px-3 py-1 text-xs font-semibold rounded-full ${isCorrect ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800'}">${isCorrect ? 'Đúng' : 'Sai'}</span>
                        </div>
                        <div class="prose mt-4">${q.content}</div>
                        <div class="mt-4 space-y-2">${answerHTML}</div>
                        ${q.explanation ? `<div class="mt-4 pt-4 border-t border-slate-200 prose prose-sm text-slate-600"><strong>Giải thích:</strong> ${q.explanation}</div>` : ''}
                    `;
                    resultModalContent.appendChild(questionCard);
                });
                feather.replace();
                if (window.renderMathInElement) {
                    renderMathInElement(resultModalContent, { delimiters: [{left: "$$", right: "$$", display: true}, {left: "$", right: "$", display: false}] });
                }
            }


            function renderProgressChart(submissions) {
                const ctx = document.getElementById('progress-chart').getContext('2d');
                const labels = submissions.map(r => r.completedAt.toDate().toLocaleDateString('vi-VN'));
                const scores = submissions.map(r => (r.score / r.totalQuestions) * 10);

                if (progressChart) {
                    progressChart.destroy();
                }

                progressChart = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: labels,
                        datasets: [{
                            label: 'Điểm (thang 10)',
                            data: scores,
                            borderColor: '#0D9488',
                            backgroundColor: 'rgba(13, 148, 136, 0.1)',
                            fill: true,
                            tension: 0.4,
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: { y: { beginAtZero: true, max: 10 } }
                    }
                });
            }

            function setupEventListeners() {
                document.querySelectorAll('.nav-link').forEach(link => {
                    link.addEventListener('click', function(e) {
                        e.preventDefault();
                        document.body.style.opacity = '0';
                        setTimeout(() => { window.location.href = this.href; }, 200);
                    });
                });
                document.body.style.transition = 'opacity 0.2s ease-in-out';
                document.getElementById('logout-btn').addEventListener('click', () => signOut(auth));

                const closeModal = () => {
                    resultModal.classList.add('hidden');
                    resultModal.classList.remove('flex');
                };
                resultModalCloseBtn.addEventListener('click', closeModal);
                resultModalBackdrop.addEventListener('click', closeModal);
            }
            
            feather.replace();
        });
    </script>
</body>
</html>

