<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <link rel="icon" type="image/png" href="https://i.ibb.co/JWTx6WrX/FAVICON.png">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Kết quả Bài làm - AIGEO</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Be+Vietnam+Pro:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/feather-icons"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.css" crossorigin="anonymous">
    <script src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/contrib/auto-render.min.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <style>
        :root {
            --primary-teal: #0D9488;
            --primary-emerald: #10B981;
        }
        body { 
            font-family: 'Be Vietnam Pro', sans-serif; 
            background-color: #f1f5f9; 
        }
        .sidebar-link { display: flex; align-items: center; padding: 0.75rem 1rem; border-radius: 0.5rem; transition: background-color 0.2s, color 0.2s; }
        .sidebar-link:hover { background-color: #e2e8f0; color: #0f172a; }
        .sidebar-link.active { 
            background: linear-gradient(90deg, var(--primary-teal), var(--primary-emerald));
            color: white; 
            font-weight: 600; 
            box-shadow: 0 4px 10px rgba(13, 148, 136, 0.2);
        }
        .sidebar-link.active:hover { background: linear-gradient(90deg, var(--primary-teal), var(--primary-emerald)); }
        .sidebar-link.active svg { color: white; }
        .sidebar-link svg { margin-right: 0.75rem; }
        .brand-gradient-text {
            background: linear-gradient(90deg, var(--primary-teal), var(--primary-emerald));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }
        .cta-button {
            background: linear-gradient(90deg, var(--primary-teal), var(--primary-emerald));
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(13, 148, 136, 0.2);
        }
        .cta-button:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(13, 148, 136, 0.3);
        }
        .prose { max-width: none; }
        .skeleton { background-color: #e2e8f0; border-radius: 0.5rem; animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite; }
        @keyframes pulse { 50% { opacity: .5; } }
        .answer-option.correct { background-color: #dcfce7 !important; border-color: #22c55e !important; }
        .answer-option.incorrect { background-color: #fee2e2 !important; border-color: #ef4444 !important; }
        #confetti-canvas { position: fixed; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 100; }
    </style>
</head>
<body class="flex h-screen">
    <canvas id="confetti-canvas"></canvas>
    <aside class="w-64 bg-white shadow-md flex-shrink-0 flex flex-col">
        <div class="h-16 flex-shrink-0 flex items-center justify-center border-b px-4">
            <a href="/index.html" class="flex items-center gap-2">
                <img src="https://i.ibb.co/JWTx6WrX/FAVICON.png" alt="AIGEO Logo" class="h-8 w-auto">
                <span class="text-2xl font-bold brand-gradient-text">AIGEO</span>
            </a>
        </div>
        <nav class="flex-grow p-4 space-y-2 overflow-y-auto">
            <a href="index.html" class="sidebar-link text-slate-600 nav-link"><i data-feather="home"></i>Bảng điều khiển</a>
            <a href="classrooms.html" class="sidebar-link text-slate-600 nav-link"><i data-feather="book"></i>Lớp học của tôi</a>
            <a href="practice-hub.html" class="sidebar-link active"><i data-feather="zap"></i>Luyện tập</a>
            <a href="stats.html" class="sidebar-link text-slate-600 nav-link"><i data-feather="bar-chart-2"></i>Thống kê</a>
            <a href="chat-bot.html" class="sidebar-link text-slate-600 nav-link"><i data-feather="message-circle"></i>Chatbot AI</a>
            <a href="account.html" class="sidebar-link text-slate-600 nav-link"><i data-feather="user"></i>Tài khoản</a>
        </nav>
        <div class="p-4 border-t flex-shrink-0"><button id="logout-btn" class="w-full sidebar-link text-slate-600 text-left"><i data-feather="log-out"></i>Đăng xuất</button></div>
    </aside>

    <main class="flex-1 flex flex-col overflow-hidden">
        <header class="bg-white shadow-sm h-16 flex items-center justify-end px-6">
            <div class="flex items-center">
                <span id="user-name" class="font-semibold text-gray-700 mr-4">Đang tải...</span>
                <img id="user-avatar" class="h-10 w-10 rounded-full object-cover" src="https://placehold.co/40x40/E2E8F0/475569?text=S" alt="Student Avatar">
            </div>
        </header>
        <div class="flex-1 overflow-x-hidden overflow-y-auto bg-slate-100 p-8">
            <div id="result-page-content" class="max-w-4xl mx-auto opacity-0 transition-opacity duration-500">
                <h1 id="test-name-title" class="text-3xl font-bold text-slate-800">Kết quả Bài làm</h1>
                
                <div class="mt-6 bg-white p-6 rounded-xl shadow-lg grid grid-cols-2 md:grid-cols-4 gap-6 text-center">
                    <div>
                        <p class="text-sm font-semibold text-slate-500">ĐIỂM SỐ</p>
                        <p class="text-5xl font-bold text-teal-600 mt-2" id="score-display"><span class="skeleton h-12 w-24 inline-block"></span></p>
                    </div>
                    <div>
                        <p class="text-sm font-semibold text-slate-500">TRẢ LỜI ĐÚNG</p>
                        <p class="text-3xl font-bold text-slate-700 mt-2" id="raw-score-display"><span class="skeleton h-9 w-20 inline-block"></span></p>
                    </div>
                    <div>
                        <p class="text-sm font-semibold text-slate-500">THỜI GIAN</p>
                        <p class="text-3xl font-bold text-slate-700 mt-2" id="time-taken-display"><span class="skeleton h-9 w-24 inline-block"></span></p>
                    </div>
                     <div>
                        <p class="text-sm font-semibold text-slate-500">NGÀY LÀM</p>
                        <p class="text-3xl font-bold text-slate-700 mt-2" id="completed-at-display"><span class="skeleton h-9 w-28 inline-block"></span></p>
                    </div>
                </div>

                <div class="mt-8 grid grid-cols-1 lg:grid-cols-3 gap-6 items-start">
                    <div class="lg:col-span-2 bg-white p-6 rounded-xl shadow-sm">
                        <div class="flex justify-between items-center mb-4">
                             <h2 class="text-xl font-bold text-slate-800 flex items-center"><i data-feather="cpu" class="w-6 h-6 mr-3 text-teal-600"></i>Nhận xét từ AI</h2>
                             <div class="flex items-center space-x-2">
                                <button id="ai-retry-btn" class="hidden bg-yellow-100 text-yellow-800 text-sm font-semibold px-4 py-2 rounded-lg flex items-center">
                                    <i data-feather="refresh-cw" class="w-4 h-4 mr-2"></i>Thử lại
                                </button>
                                <button id="ai-detail-btn" class="cta-button text-white text-sm font-semibold px-4 py-2 rounded-lg flex items-center">
                                    <i data-feather="zoom-in" class="w-4 h-4 mr-2"></i>Xem phân tích chi tiết
                                </button>
                             </div>
                        </div>
                        <div id="ai-feedback" class="prose prose-sm text-slate-600"><div class="skeleton h-24 w-full"></div></div>
                    </div>
                    <div class="bg-white p-6 rounded-xl shadow-sm">
                         <h3 class="font-bold text-slate-700 mb-3 flex items-center"><i data-feather="target" class="w-5 h-5 mr-2 text-red-500"></i>Nội dung cần ôn lại</h3>
                         <ul id="review-topics" class="space-y-2 text-slate-600"><li class="skeleton h-5 w-full"></li><li class="skeleton h-5 w-3/4"></li></ul>
                    </div>
                </div>

                <div class="mt-8">
                    <div class="flex flex-col md:flex-row justify-between md:items-center mb-4 gap-4">
                         <h2 class="text-xl font-bold text-slate-700">Xem lại chi tiết bài làm</h2>
                         <div id="action-buttons" class="flex space-x-2">
                             <a id="back-to-hub" href="practice-hub.html" class="bg-white text-slate-700 font-semibold px-4 py-2 rounded-lg border border-slate-300 hover:bg-slate-50 transition nav-link flex items-center"><i data-feather="zap" class="w-4 h-4 mr-2"></i>Luyện tập tiếp</a>
                             <a id="retry-test-btn" href="#" class="bg-white text-teal-600 font-semibold px-4 py-2 rounded-lg border border-teal-300 hover:bg-teal-50 transition nav-link flex items-center">
                                <i data-feather="refresh-cw" class="w-4 h-4 mr-2"></i>Làm lại
                             </a>
                             <a id="back-to-dashboard" href="index.html" class="cta-button text-white font-semibold px-4 py-2 rounded-lg nav-link flex items-center"><i data-feather="home" class="w-4 h-4 mr-2"></i>Về trang chủ</a>
                         </div>
                    </div>
                    <div id="review-container" class="space-y-6">
                        <div class="skeleton h-40 w-full"></div>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <script src="../firebase-config.js"></script>
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, collection, getDocs, query, where } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        document.addEventListener('DOMContentLoaded', () => {
            const app = initializeApp(firebaseConfig);
            const auth = getAuth(app);
            const db = getFirestore(app);
            
            const userNameEl = document.getElementById('user-name');
            const userAvatarEl = document.getElementById('user-avatar');
            const scoreDisplayEl = document.getElementById('score-display');
            const rawScoreDisplayEl = document.getElementById('raw-score-display');
            const timeTakenDisplay = document.getElementById('time-taken-display');
            const completedAtDisplay = document.getElementById('completed-at-display');
            const testNameTitle = document.getElementById('test-name-title');
            const aiFeedbackEl = document.getElementById('ai-feedback');
            const reviewTopicsEl = document.getElementById('review-topics');
            const reviewContainerEl = document.getElementById('review-container');
            const resultPageContent = document.getElementById('result-page-content');
            const aiDetailBtn = document.getElementById('ai-detail-btn');
            const aiRetryBtn = document.getElementById('ai-retry-btn'); 
            const actionButtons = document.getElementById('action-buttons');
            const retryTestBtn = document.getElementById('retry-test-btn');
            
            let currentUser = null;
            let currentResultData = null;
            let currentQuestions = [];
            let allLessonsCache = [];
            let apiKeysCache = null;

            onAuthStateChanged(auth, async (user) => {
                if (!user) { window.location.href = '../auth.html'; return; }
                currentUser = user;
                const userDocRef = doc(db, "users", user.uid);
                const docSnap = await getDoc(userDocRef);
                if (docSnap.exists() && docSnap.data().role === 'student') {
                    const userData = docSnap.data();
                    userNameEl.textContent = userData.name || 'Học sinh';
                    const nameInitial = (userData.name || 'S').charAt(0).toUpperCase();
                    userAvatarEl.src = `https://placehold.co/40x40/10B981/FFFFFF?text=${nameInitial}`;
                    initResultPage();
                } else {
                    window.location.href = `../${docSnap.data()?.role || 'auth'}/index.html`;
                }
            });
            
             function cleanPrefix(text) {
                 if (!text) return '';
                 return text.replace(/^(Bài|Chương|Phần|Câu)\s*\d+\s*[:.]?\s*/i, '').trim();
             }

            async function initResultPage() {
                try {
                    const resultId = sessionStorage.getItem('latestResultId');
                    if (!resultId) throw new Error("Không tìm thấy mã kết quả. Vui lòng quay lại và thử lại.");
                    const resultDocRef = doc(db, "submissions", resultId);
                    const resultSnap = await getDoc(resultDocRef);
                    if (!resultSnap.exists()) throw new Error("Không tìm thấy dữ liệu kết quả.");
                    
                    currentResultData = resultSnap.data();
                    const { score, totalQuestions, userAnswers, incorrectQuestions, questionIds, embeddedQuestions, timeTaken, completedAt, testName, type, testId, classId } = currentResultData;
                    
                    if (testName.startsWith("Luyện tập")) {
                        actionButtons.querySelector('#back-to-hub').classList.add('hidden');
                    }

                    // Populate Summary Card
                    const tenPointScore = totalQuestions > 0 ? (score / totalQuestions) * 10 : 0;
                    scoreDisplayEl.textContent = tenPointScore.toFixed(1);
                    rawScoreDisplayEl.textContent = `${score}/${totalQuestions}`;
                    testNameTitle.textContent = `Kết quả: ${testName}`;
                    const minutes = Math.floor((timeTaken || 0) / 60);
                    const seconds = (timeTaken || 0) % 60;
                    timeTakenDisplay.textContent = `${minutes}m ${seconds}s`;
                    completedAtDisplay.textContent = completedAt.toDate().toLocaleDateString('vi-VN');
                    if(tenPointScore >= 8) launchConfetti();

                    if (classId) {
                        retryTestBtn.href = `test.html?testId=${testId}&classId=${classId}`;
                    } else {
                        retryTestBtn.href = `practice-test.html?testId=${testId}`;
                    }
                    
                    const [fetchedQuestions, allLessons, apiKeySnap] = await Promise.all([
                        fetchQuestions(questionIds),
                        fetchAllLessons(),
                        getDoc(doc(db, "system_settings", "api_keys"))
                    ]);
                    
                    allLessonsCache = allLessons; // Lưu cache
                    apiKeysCache = apiKeySnap.exists() ? apiKeySnap.data() : null; // Lưu cache
                    currentQuestions = [...(embeddedQuestions || []), ...fetchedQuestions];

                    renderReviewSection(currentQuestions, userAnswers, allLessonsCache);
                    
                    const uniqueIncorrectLessonIds = [...new Set((incorrectQuestions || []).map(q => q.lessonId).filter(id => id))];
                    const topicsToReview = allLessonsCache.filter(l => uniqueIncorrectLessonIds.includes(l.id));
                    reviewTopicsEl.innerHTML = topicsToReview.length > 0
                        ? topicsToReview.map(l => `<li><i data-feather="target" class="w-4 h-4 inline-block mr-2 text-red-500"></i>${cleanPrefix(l.name)}</li>`).join('')
                        : `<li><i data-feather="check-circle" class="w-4 h-4 inline-block mr-2 text-green-500"></i>Làm tốt lắm, không có lỗi sai!</li>`;
                    
                    const aiFeedbackFn = (isDetailed) => getAiFeedback(
                        incorrectQuestions || [], 
                        topicsToReview, 
                        score, 
                        totalQuestions, 
                        apiKeysCache, 
                        isDetailed
                    );

                    // Thêm listener cho các nút AI
                    aiDetailBtn.addEventListener('click', () => aiFeedbackFn(true));
                    aiRetryBtn.addEventListener('click', () => aiFeedbackFn(false)); // Nút thử lại sẽ gọi lại bản tóm tắt

                    aiFeedbackFn(false); // Tải bản tóm tắt ban đầu
                    
                    resultPageContent.classList.add('opacity-100');
                    feather.replace();

                } catch (error) {
                    console.error("Error loading result page:", error);
                    const mainContent = document.querySelector('.max-w-4xl.mx-auto');
                    if (mainContent) {
                        mainContent.innerHTML = `<div class="bg-white p-8 rounded-xl shadow-lg text-center">
                            <i data-feather="alert-triangle" class="w-16 h-16 mx-auto text-red-500"></i>
                            <h2 class="mt-4 text-2xl font-bold text-slate-800">Đã xảy ra lỗi</h2>
                            <p class="mt-2 text-slate-600">${error.message}</p>
                            <a href="index.html" class="mt-6 inline-block cta-button text-white font-semibold px-6 py-3 rounded-lg">
                                Về trang tổng quan
                            </a>
                        </div>`;
                        feather.replace();
                    }
                }
            }
            
            async function fetchQuestions(questionIds) {
                if (!questionIds || questionIds.length === 0) return [];
                const fetchedQuestions = [];
                const CHUNK_SIZE = 30;
                for (let i = 0; i < questionIds.length; i += CHUNK_SIZE) {
                    const chunk = questionIds.slice(i, i + CHUNK_SIZE);
                    const q = query(collection(db, "questions"), where("__name__", "in", chunk));
                    const snapshot = await getDocs(q);
                    snapshot.forEach(doc => fetchedQuestions.push({ id: doc.id, ...doc.data() }));
                }
                const originalIdOrder = currentResultData.questionIds || [];
                return fetchedQuestions.sort((a, b) => originalIdOrder.indexOf(a.id) - originalIdOrder.indexOf(b.id));
            }
            
            async function fetchAllLessons() {
                const lessonsSnap = await getDocs(collection(db, "lessons"));
                return lessonsSnap.docs.map(d => ({ id: d.id, ...d.data() }));
            }
            
            function renderReviewSection(questions, userAnswers, allLessons) {
                reviewContainerEl.innerHTML = '';
                const originalIdOrder = currentResultData.questionIds || questions.map(q => q.id);
                const sortedQuestions = questions.sort((a, b) => originalIdOrder.indexOf(a.id) - originalIdOrder.indexOf(b.id));

                sortedQuestions.forEach((q, index) => {
                    const lesson = allLessons.find(l => l.id === q.lessonId);
                    const userAnswer = userAnswers[q.id];
                    let isCorrect = false;
                    let answerHTML = '';
                    if (q.type === 'multiple_choice') {
                         const originalAnswer = q.shuffledOptions?.find(opt => opt.originalLetter === q.correctAnswer);
                         const selectedOption = q.shuffledOptions?.find((opt, i) => String.fromCharCode(65 + i) === userAnswer);
                         isCorrect = selectedOption?.originalLetter === q.correctAnswer;

                        answerHTML = (q.shuffledOptions || []).map((optionData, i) => {
                            const optionLetter = String.fromCharCode(65 + i);
                            let classes = 'answer-option border-2 border-slate-200 p-4 rounded-lg mt-2 flex items-start';
                            if(optionData.originalLetter === q.correctAnswer) classes += ' correct';
                            else if (optionLetter === userAnswer && !isCorrect) classes += ' incorrect';
                            return `<div class="${classes}"><span class="font-bold mr-2">${optionLetter}.</span> <div>${optionData.content}</div></div>`;
                        }).join('');

                    } else if (q.type === 'short_answer') {
                        const formattedCorrectAnswer = String(q.correctAnswer).trim().toLowerCase();
                        const formattedUserAnswer = String(userAnswer || "").trim().toLowerCase();
                        isCorrect = formattedUserAnswer === formattedCorrectAnswer;
                        answerHTML = `<div class="mt-4"><p><strong>Đáp án đúng:</strong> <span class="font-mono bg-green-100 text-green-800 px-2 py-1 rounded">${q.correctAnswer}</span></p><p><strong>Câu trả lời của bạn:</strong> <span class="font-mono ${isCorrect ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800'} px-2 py-1 rounded">${userAnswer || '(bỏ trống)'}</span></p></div>`;
                    } else if (q.type === 'true_false' || q.type === 'true_false_group') {
                        const statements = q.statements || {};
                        const statementKeys = Array.isArray(statements) ? Object.keys(statements) : Object.keys(statements).filter(k => statements[k]);

                        isCorrect = userAnswer && statementKeys.length > 0 && statementKeys.every(key => {
                             const correctAnswer = Array.isArray(statements) ? statements[key].answer : q.answers[key];
                             return userAnswer[key] === correctAnswer;
                        });
                        
                        answerHTML = statementKeys.map(key => {
                             const statementContent = Array.isArray(statements) ? statements[key].statement : statements[key];
                             if(!statementContent) return '';
                             
                             const userAns = userAnswer ? userAnswer[key] : undefined;
                             const correctAns = Array.isArray(statements) ? statements[key].answer : q.answers[key];
                             const isSubCorrect = userAns === correctAns;
                             
                             const displayKey = Array.isArray(statements) ? (parseInt(key, 10) + 1) : key;

                             return `<div class="p-3 border-t"><p>${displayKey}) ${statementContent}</p><div class="text-sm mt-2"><span>Đáp án: <strong class="${correctAns ? 'text-green-600' : 'text-red-600'}">${correctAns ? 'Đúng' : 'Sai'}</strong></span> | <span>Bạn chọn: <strong class="${isSubCorrect ? 'text-green-600' : 'text-red-600'}">${userAns === undefined ? '(bỏ trống)' : (userAns ? 'Đúng' : 'Sai')}</strong></span></div></div>`;
                        }).join('');
                        answerHTML = `<div class="mt-4 border rounded-lg divide-y">${answerHTML}</div>`;
                    }
                    const questionCard = document.createElement('div');
                    questionCard.className = 'bg-white p-6 rounded-xl shadow-sm';
                    questionCard.innerHTML = `
                        <div class="flex justify-between items-start">
                            <div><p class="font-bold text-slate-800">Câu ${index + 1}</p><p class="text-xs text-slate-500 mt-1">Chủ đề: ${lesson ? cleanPrefix(lesson.name) : 'N/A'}</p></div>
                            <span class="px-3 py-1 text-xs font-semibold rounded-full ${isCorrect ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800'}">${isCorrect ? 'Đúng' : 'Sai'}</span>
                        </div>
                        ${q.imageUrl ? `<div class="my-4"><img src="${q.imageUrl}" alt="Hình ảnh câu hỏi" class="max-w-full h-auto rounded-lg mx-auto border"></div>` : ''}
                        <div class="prose mt-4">${q.content}</div>
                        <div class="mt-4 space-y-2">${answerHTML}</div>
                        ${q.explanation ? `<div class="mt-4 pt-4 border-t border-slate-200 prose prose-sm text-slate-600"><strong>Giải thích:</strong> ${q.explanation}</div>` : ''}
                    `;
                    reviewContainerEl.appendChild(questionCard);
                });
                renderMathWithKaTeX(reviewContainerEl);
            }

            function getNextApiKey(openRouterKeys) {
                let currentKeyIndex = parseInt(sessionStorage.getItem('orKeyIndex') || '0', 10) % openRouterKeys.length;
                const key = openRouterKeys[currentKeyIndex];
                sessionStorage.setItem('orKeyIndex', ((currentKeyIndex + 1) % openRouterKeys.length).toString());
                return key;
            }

            // *** HÀM getAiFeedback ĐÃ CẬP NHẬT VỚI LOGIC TỰ ĐỘNG THỬ LẠI ***
            async function getAiFeedback(incorrectQuestions, topicsToReview, score, total, apiKeysData, isDetailed) {
                const openRouterKeys = apiKeysData?.openrouter_keys;
                if (!openRouterKeys || openRouterKeys.length === 0) {
                    aiFeedbackEl.innerHTML = "Tính năng nhận xét AI chưa được cấu hình."; return;
                }
                
                aiDetailBtn.disabled = true;
                aiRetryBtn.classList.add('hidden'); // Ẩn nút thử lại khi bắt đầu
                aiDetailBtn.innerHTML = `<i data-feather="loader" class="animate-spin w-4 h-4 mr-2"></i>Đang phân tích...`;
                feather.replace();

                if(incorrectQuestions.length === 0) {
                    aiFeedbackEl.innerHTML = "<strong>Xuất sắc!</strong><p>Bạn đã trả lời đúng tất cả các câu hỏi. Hãy tiếp tục phát huy nhé!</p>"; 
                    aiDetailBtn.classList.add('hidden');
                    return;
                }
                
                let systemPrompt, userPrompt;

                if (isDetailed) {
                    const incorrectQuestionsData = currentQuestions.filter(q => incorrectQuestions.some(iq => iq.questionContent === q.content));
                    const detailedIncorrectContent = incorrectQuestionsData.map((q, index) => {
                        let questionText = `Câu ${index + 1}: ${q.content}\n`;
                        if (q.type === 'multiple_choice') {
                            questionText += (q.shuffledOptions || []).map((opt, i) => `  ${String.fromCharCode(65+i)}. ${opt.content}`).join('\n');
                            const correctLetter = q.shuffledOptions.find(opt => opt.originalLetter === q.correctAnswer);
                            const correctChoice = correctLetter ? String.fromCharCode(65 + q.shuffledOptions.indexOf(correctLetter)) : q.correctAnswer;
                            questionText += `\n  Đáp án đúng: ${correctChoice}`;
                        } else {
                            questionText += `\n  Đáp án đúng: ${q.correctAnswer}`;
                        }
                        return questionText;
                    }).join('\n\n');

                    systemPrompt = "Bạn là một gia sư AI chuyên nghiệp của AIGEO. Nhiệm vụ của bạn là giải thích chi tiết, từng bước một cho từng câu hỏi sai mà người dùng cung cấp. Luôn trả lời bằng tiếng Việt. BẮT BUỘC sử dụng định dạng HTML (ví dụ: <p>, <strong>, <ul>, <li>) và công thức KaTeX (ví dụ: $ax^2+b=0$) nếu cần. Hãy trình bày rõ ràng cho từng câu.";
                    userPrompt = `Vui lòng phân tích và giải thích chi tiết các câu hỏi sai dưới đây. Hãy giải thích rõ tại sao đáp án đúng lại đúng và tại sao các lựa chọn khác (nếu có) lại sai.\n\n${detailedIncorrectContent}`;
                } else {
                    const topicsContent = topicsToReview.map(t => cleanPrefix(t.name)).join(', ');
                    systemPrompt = "Bạn là một gia sư AI thân thiện và chuyên nghiệp của AIGEO. Hãy đưa ra một nhận xét ngắn gọn (3-4 câu) bằng tiếng Việt cho kết quả bài làm của học sinh. Nhận xét cần mang tính xây dựng và động viên. BẮT BUỘC sử dụng định dạng HTML (ví dụ: <p>, <strong>, <ul>, <li>) và bắt đầu bằng <strong>. Không dùng markdown.";
                    userPrompt = `Học sinh đạt ${score}/${total} điểm. Các chủ đề bị sai: ${topicsContent || 'Không có'}. Hãy viết một nhận xét ngắn gọn: 1. Động viên. 2. Chỉ ra (các) mảng kiến thức chính cần củng cố. 3. Đề xuất hành động (ví dụ: ôn lại bài, làm thêm bài tập).`;
                }

                aiFeedbackEl.innerHTML = '<p class="text-center text-slate-500"><div class="animate-spin rounded-full h-6 w-6 border-b-2 border-teal-500 mx-auto"></div> Đang tạo nhận xét...</p>';
                
                const MAX_RETRIES = 3;
                let lastError = null;

                for (let attempt = 1; attempt <= MAX_RETRIES; attempt++) {
                    const openRouterApiKey = getNextApiKey(openRouterKeys);
                    if (!openRouterApiKey) {
                        lastError = new Error("Chưa cấu hình OpenRouter API Key.");
                        break; 
                    }
                    
                    try {
                        const response = await fetch(`https://openrouter.ai/api/v1/chat/completions`, {
                            method: 'POST',
                            headers: { 
                                'Authorization': `Bearer ${openRouterApiKey}`, 'Content-Type': 'application/json',
                                'HTTP-Referer': `https://${firebaseConfig.projectId}.web.app`, 'X-Title': 'AIGEO Student Review' 
                            },
                            body: JSON.stringify({ 
                                model: "openai/gpt-oss-20b:free",
                                messages: [{ role: "system", content: systemPrompt }, { role: "user", content: userPrompt }] 
                            })
                        });

                        if (response.ok) {
                            // THÀNH CÔNG
                            const data = await response.json();
                            const text = data.choices[0]?.message?.content;
                            if (!text) throw new Error("Phản hồi từ AI không hợp lệ.");
                            
                            const renderedHtml = marked.parse(text);
                            aiFeedbackEl.innerHTML = renderedHtml;
                            renderMathWithKaTeX(aiFeedbackEl);
                            
                            aiDetailBtn.disabled = false;
                            aiDetailBtn.innerHTML = `<i data-feather="zoom-in" class="w-4 h-4 mr-2"></i>Xem phân tích chi tiết`;
                            feather.replace();
                            return; // Thoát khỏi hàm thành công
                        }

                        // LỖI HTTP - Sẽ thử lại với bất kỳ lỗi nào
                        try {
                            const errorData = await response.json();
                            lastError = new Error(errorData.error.message || `Lỗi API: ${response.status} ${response.statusText}`);
                        } catch (e) {
                            lastError = new Error(`Lỗi API: ${response.status} ${response.statusText}`);
                        }
                        
                        console.warn(`Attempt ${attempt} failed with error: ${lastError.message}.`);

                        if (attempt < MAX_RETRIES) {
                            const delay = Math.pow(2, attempt) * 1000; // 2s, 4s
                            console.warn(`Retrying in ${delay / 1000}s...`);
                            await new Promise(resolve => setTimeout(resolve, delay));
                        }

                    } catch (error) { // Lỗi mạng (fetch thất bại)
                        lastError = error;
                        console.error(`Attempt ${attempt} network error:`, error);
                        if (attempt < MAX_RETRIES) {
                            const delay = Math.pow(2, attempt) * 1000;
                            await new Promise(resolve => setTimeout(resolve, delay));
                        }
                    }
                }
                
                // Nếu vòng lặp kết thúc mà không return, nghĩa là TẤT CẢ đã thất bại
                console.error("AI Feedback Error (after all retries):", lastError);
                aiFeedbackEl.innerHTML = `<div class="p-3 bg-red-50 text-red-700 rounded-lg"><p class="font-semibold">Lỗi tạo nhận xét AI</p><p class="text-sm">${lastError.message}</p></div>`;
                aiRetryBtn.classList.remove('hidden'); // Hiển thị nút thử lại thủ công

                // Đặt lại trạng thái nút
                aiDetailBtn.disabled = false;
                aiDetailBtn.innerHTML = `<i data-feather="zoom-in" class="w-4 h-4 mr-2"></i>Xem phân tích chi tiết`;
                feather.replace();
            }
            
            function renderMathWithKaTeX(elem) {
                if (window.renderMathInElement) { renderMathInElement(elem, { delimiters: [{left: "$$", right: "$$", display: true}, {left: "$", right: "$", display: false}] }); }
            }

            function launchConfetti() {
                const canvas = document.getElementById('confetti-canvas');
                if (!canvas) return;
                const ctx = canvas.getContext('2d');
                canvas.width = window.innerWidth;
                canvas.height = window.innerHeight;
                let confetti = [];
                const confettiCount = 200;
                const colors = ['#0D9488', '#10B981', '#34D399', '#6EE7B7'];
                for (let i = 0; i < confettiCount; i++) {
                    confetti.push({
                        x: Math.random() * canvas.width, y: Math.random() * canvas.height - canvas.height,
                        r: Math.random() * 5 + 2, d: Math.random() * confettiCount,
                        color: colors[Math.floor(Math.random() * colors.length)],
                        tilt: Math.floor(Math.random() * 10) - 10,
                        tiltAngleIncremental: (Math.random() * 0.07) + .05, tiltAngle: 0
                    });
                }
                function draw() {
                    if (!ctx) return;
                    ctx.clearRect(0, 0, canvas.width, canvas.height);
                    confetti.forEach((c) => {
                        ctx.beginPath(); ctx.lineWidth = c.r / 2; ctx.strokeStyle = c.color;
                        ctx.moveTo(c.x + c.tilt, c.y); ctx.lineTo(c.x, c.y + c.tilt + c.r / 2);
                        ctx.stroke();
                    });
                    update();
                }
                function update() {
                    let remaining = 0;
                    confetti.forEach((c, i) => {
                        c.tiltAngle += c.tiltAngleIncremental;
                        c.y += (Math.cos(c.d + i) + 2 + c.r / 2);
                        c.x += Math.sin(c.d);
                        c.tilt = (Math.sin(c.tiltAngle - (i / 3))) * 15;
                        if (c.y < canvas.height) remaining++;
                    });
                    if (remaining > 0) requestAnimationFrame(draw);
                }
                requestAnimationFrame(draw);
            }

            document.querySelectorAll('.nav-link').forEach(link => {
                link.addEventListener('click', function(e) {
                    e.preventDefault();
                    document.body.style.opacity = '0';
                    setTimeout(() => { window.location.href = this.href; }, 200);
                });
            });
            document.body.style.transition = 'opacity 0.2s ease-in-out';
            document.getElementById('logout-btn').addEventListener('click', () => signOut(auth));
            feather.replace();
        });
    </script>
</body>
</html>