<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <link rel="icon" type="image/png" href="https://i.ibb.co/JWTx6WrX/FAVICON.png">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Trung tâm Luyện tập - AIGEO</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Be+Vietnam+Pro:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/feather-icons"></script>
    <style>
        :root {
            --primary-teal: #0D9488;
            --primary-emerald: #10B981;
        }
        body { 
            font-family: 'Be Vietnam Pro', sans-serif; 
            background-color: #f1f5f9; 
        }
        .sidebar-link { display: flex; align-items: center; padding: 0.75rem 1rem; border-radius: 0.5rem; transition: background-color 0.2s, color 0.2s; }
        .sidebar-link:hover { background-color: #e2e8f0; color: #0f172a; }
        .sidebar-link.active { 
            background: linear-gradient(90deg, var(--primary-teal), var(--primary-emerald));
            color: white; 
            font-weight: 600; 
            box-shadow: 0 4px 10px rgba(13, 148, 136, 0.2);
        }
        .sidebar-link.active:hover { background: linear-gradient(90deg, var(--primary-teal), var(--primary-emerald)); }
        .sidebar-link.active svg { color: white; }
        .sidebar-link svg { margin-right: 0.75rem; }
        
        .brand-gradient-text {
            background: linear-gradient(90deg, var(--primary-teal), var(--primary-emerald));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }
        .cta-button {
            background: linear-gradient(90deg, var(--primary-teal), var(--primary-emerald));
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(13, 148, 136, 0.2);
        }
        .cta-button:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(13, 148, 136, 0.3);
        }
        .skeleton { background-color: #e2e8f0; border-radius: 0.5rem; animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite; }
        @keyframes pulse { 50% { opacity: .5; } }
        /* Tab Styles */
        .tab-button { transition: all 0.2s; border-bottom: 3px solid transparent; padding: 0.75rem 0.25rem; font-weight: 600; color: #475569; cursor:pointer; }
        .tab-button.active { border-color: var(--primary-teal); color: var(--primary-teal); }
        .tab-button:hover:not(.active) { color: var(--primary-teal); }
        .tab-content { display: none; }
        .tab-content.active { display: block; animation: fadeIn 0.5s; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        
        /* New Lesson Card Style */
        .lesson-card {
            transition: all 0.2s ease-in-out;
        }
        .lesson-card:has(input:checked) {
             border-color: var(--primary-teal);
             background-color: #f0fdfa;
             transform: translateY(-2px);
             box-shadow: 0 4px 10px rgba(13, 148, 136, 0.1);
        }
        .lesson-card:has(input:checked) .lesson-check-icon {
            opacity: 1;
            transform: scale(1);
        }
        .lesson-check-icon {
            opacity: 0;
            transform: scale(0.5);
            transition: all 0.2s ease-in-out;
        }

        .toast { transition: transform 0.3s ease-in-out, opacity 0.3s ease-in-out; transform: translateY(100%); opacity: 0; }
        .toast.show { transform: translateY(0); opacity: 1; }
    </style>
</head>
<body class="flex h-screen">

    <aside class="w-64 bg-white shadow-md flex-shrink-0 flex flex-col">
        <div class="h-16 flex-shrink-0 flex items-center justify-center border-b px-4">
            <a href="/index.html" class="flex items-center gap-2">
                <img src="https://i.ibb.co/JWTx6WrX/FAVICON.png" alt="AIGEO Logo" class="h-8 w-auto">
                <span class="text-2xl font-bold brand-gradient-text">AIGEO</span>
            </a>
        </div>
        <nav class="flex-grow p-4 space-y-2 overflow-y-auto">
            <a href="index.html" class="sidebar-link text-slate-600 nav-link"><i data-feather="home"></i>Bảng điều khiển</a>
            <a href="classrooms.html" class="sidebar-link text-slate-600 nav-link"><i data-feather="book"></i>Lớp học của tôi</a>
            <a href="practice-hub.html" class="sidebar-link active"><i data-feather="zap"></i>Luyện tập</a>
            <a href="stats.html" class="sidebar-link text-slate-600 nav-link"><i data-feather="bar-chart-2"></i>Thống kê</a>
            <a href="chat-bot.html" class="sidebar-link text-slate-600 nav-link"><i data-feather="message-circle"></i>Chatbot AI</a>
            <a href="account.html" class="sidebar-link text-slate-600 nav-link"><i data-feather="user"></i>Tài khoản</a>
        </nav>
        <div class="p-4 border-t flex-shrink-0"><button id="logout-btn" class="w-full sidebar-link text-slate-600 text-left"><i data-feather="log-out"></i>Đăng xuất</button></div>
    </aside>

    <main class="flex-1 flex flex-col overflow-hidden">
        <header class="bg-white shadow-sm h-16 flex items-center justify-end px-6">
             <div class="flex items-center">
                <span id="user-name" class="font-semibold text-gray-700 mr-4">Đang tải...</span>
                <img id="user-avatar" class="h-10 w-10 rounded-full object-cover" src="https://placehold.co/40x40/E2E8F0/475569?text=S" alt="Student Avatar">
            </div>
        </header>
        
        <main class="flex-1 overflow-x-hidden overflow-y-auto bg-slate-100 p-8">
            <div class="max-w-7xl mx-auto">
                <a href="practice.html" class="flex items-center text-slate-500 hover:text-teal-600 font-semibold mb-4 nav-link">
                    <i data-feather="arrow-left" class="mr-2 w-4 h-4"></i>Quay lại
                </a>
                <h1 class="text-3xl font-bold text-slate-800">Trung tâm Luyện tập</h1>
                <p class="mt-2 text-slate-600">Chọn một phương thức luyện tập phù hợp với mục tiêu của bạn.</p>

                <div class="mt-8">
                    <div class="border-b border-gray-200">
                        <nav id="tabs-container" class="-mb-px flex space-x-8" aria-label="Tabs">
                            <button class="tab-button active" data-tab="ai-practice"><i data-feather="zap" class="inline-block mr-2 w-5 h-5"></i>Đề theo Năng lực (AI)</button>
                            <button class="tab-button" data-tab="admin-practice"><i data-feather="shield" class="inline-block mr-2 w-5 h-5"></i>Luyện Đề</button>
                            <button class="tab-button" data-tab="lesson-practice"><i data-feather="target" class="inline-block mr-2 w-5 h-5"></i>Luyện tập Theo Bài</button>
                            <button class="tab-button" data-tab="comprehensive-practice"><i data-feather="list" class="inline-block mr-2 w-5 h-5"></i>Luyện tập Tổng hợp</button>
                        </nav>
                    </div>

                    <div class="mt-5">
                        <div id="ai-practice" class="tab-content active">
                             <div class="bg-white p-6 rounded-xl shadow-sm border-t-4 border-teal-500">
                                <h2 class="text-xl font-bold text-slate-800">Đề ôn tập theo năng lực</h2>
                                <p class="mt-2 text-slate-500">Hệ thống AI sẽ phân tích các lỗi sai của bạn từ những bài làm trước để tạo ra một đề ôn tập cá nhân hóa, giúp bạn củng cố kiến thức còn yếu.</p>
                                <div id="ai-practice-content" class="mt-6">
                                    <div class="skeleton h-20 w-full"></div>
                                </div>
                            </div>
                        </div>

                        <div id="admin-practice" class="tab-content">
                            <div class="bg-white p-6 rounded-xl shadow-sm border-t-4 border-indigo-500">
                                <h2 class="text-xl font-bold text-slate-800">Luyện Đề từ Ngân hàng chung</h2>
                                <p class="mt-2 text-slate-500">Đây là danh sách các đề thi đã được xuất bản, phù hợp cho việc ôn tập và củng cố kiến thức tổng quát.</p>
                                <div id="admin-tests-container" class="mt-6 space-y-4">
                                    <div class="skeleton h-24 w-full"></div>
                                </div>
                            </div>
                        </div>
                        
                        <div id="lesson-practice" class="tab-content">
                            <div class="bg-white p-6 rounded-xl shadow-sm border-t-4 border-sky-500">
                                <h2 class="text-xl font-bold text-slate-800">Luyện tập theo bài</h2>
                                <p class="mt-2 text-slate-500">Chọn Môn học và một bài học cụ thể để tạo đề ngẫu nhiên, giúp nắm vững kiến thức từng phần.</p>
                                <div class="mt-6 grid grid-cols-1 md:grid-cols-2 gap-4">
                                    <select id="filter-subject-lesson" class="p-3 border rounded-lg bg-white w-full"></select>
                                    <select id="filter-grade-lesson" class="p-3 border rounded-lg bg-white w-full" disabled></select>
                                </div>
                                <div id="lesson-list-container-lesson" class="mt-4 text-center text-slate-500 p-6 bg-slate-50 rounded-lg">
                                    Vui lòng chọn Môn học và Lớp.
                                </div>
                                <div id="question-count-wrapper-lesson" class="mt-6 space-y-2 hidden">
                                    <label for="question-count-lesson" class="text-sm font-medium text-slate-700">Số lượng câu hỏi:</label>
                                    <div class="flex items-center space-x-4">
                                        <input id="question-count-slider-lesson" type="range" min="5" max="50" value="10" class="w-full h-2 bg-slate-200 rounded-lg appearance-none cursor-pointer">
                                        <span id="question-count-label-lesson" class="font-bold text-slate-800 w-12 text-center">10</span>
                                    </div>
                                </div>
                                <div class="mt-6 flex justify-end">
                                     <button id="start-lesson-practice-btn" class="cta-button text-white font-bold px-8 py-3 rounded-lg disabled:bg-slate-400 disabled:cursor-not-allowed" disabled>
                                        Bắt đầu
                                    </button>
                                </div>
                            </div>
                        </div>

                        <div id="comprehensive-practice" class="tab-content">
                            <div class="bg-white p-6 rounded-xl shadow-sm border-t-4 border-amber-500">
                                <h2 class="text-xl font-bold text-slate-800">Luyện tập tổng hợp</h2>
                                <p class="mt-2 text-slate-500">Chọn Môn học, sau đó chọn nhiều bài học để hệ thống tạo đề tổng hợp, cân đối các dạng câu hỏi.</p>
                                <div class="mt-6 grid grid-cols-1 md:grid-cols-2 gap-4">
                                    <select id="filter-subject-comprehensive" class="p-3 border rounded-lg bg-white w-full"></select>
                                    <select id="filter-grade-comprehensive" class="p-3 border rounded-lg bg-white w-full" disabled></select>
                                </div>
                                <div id="lesson-list-container-comprehensive" class="mt-4 text-center text-slate-500 p-6 bg-slate-50 rounded-lg">
                                    Vui lòng chọn Môn học và Lớp.
                                </div>
                                <div id="filter-options-wrapper-comprehensive" class="mt-6 grid grid-cols-1 md:grid-cols-2 gap-6 hidden">
                                    <div>
                                        <label class="block text-sm font-medium text-slate-700">Chọn dạng thức câu hỏi:</label>
                                        <div id="question-type-wrapper-comprehensive" class="mt-2 flex flex-wrap gap-x-6 gap-y-2">
                                            <label class="flex items-center space-x-2 cursor-pointer">
                                                <input type="checkbox" name="question-type" value="multiple_choice" class="h-4 w-4 rounded border-gray-300 text-teal-600 focus:ring-teal-500" checked>
                                                <span class="text-sm text-slate-700">Trắc nghiệm</span>
                                                <span class="text-xs text-slate-500 ml-1" id="count-type-multiple_choice">(0)</span>
                                            </label>
                                            <label class="flex items-center space-x-2 cursor-pointer">
                                                <input type="checkbox" name="question-type" value="true_false_group" class="h-4 w-4 rounded border-gray-300 text-teal-600 focus:ring-teal-500" checked>
                                                <span class="text-sm text-slate-700">Đúng/Sai</span>
                                                <span class="text-xs text-slate-500 ml-1" id="count-type-true_false_group">(0)</span>
                                            </label>
                                            <label class="flex items-center space-x-2 cursor-pointer">
                                                <input type="checkbox" name="question-type" value="short_answer" class="h-4 w-4 rounded border-gray-300 text-teal-600 focus:ring-teal-500" checked>
                                                <span class="text-sm text-slate-700">Trả lời ngắn</span>
                                                <span class="text-xs text-slate-500 ml-1" id="count-type-short_answer">(0)</span>
                                            </label>
                                        </div>
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-slate-700">Chọn mức độ nhận thức:</label>
                                        <div id="question-difficulty-wrapper-comprehensive" class="mt-2 flex flex-wrap gap-x-6 gap-y-2">
                                            <label class="flex items-center space-x-2 cursor-pointer">
                                                <input type="checkbox" name="question-difficulty" value="nhan_biet" class="h-4 w-4 rounded border-gray-300 text-teal-600 focus:ring-teal-500" checked>
                                                <span class="text-sm text-slate-700">Nhận biết</span>
                                                <span class="text-xs text-slate-500 ml-1" id="count-difficulty-nhan_biet">(0)</span>
                                            </label>
                                            <label class="flex items-center space-x-2 cursor-pointer">
                                                <input type="checkbox" name="question-difficulty" value="thong_hieu" class="h-4 w-4 rounded border-gray-300 text-teal-600 focus:ring-teal-500" checked>
                                                <span class="text-sm text-slate-700">Thông hiểu</span>
                                                <span class="text-xs text-slate-500 ml-1" id="count-difficulty-thong_hieu">(0)</span>
                                            </label>
                                            <label class="flex items-center space-x-2 cursor-pointer">
                                                <input type="checkbox" name="question-difficulty" value="van_dung" class="h-4 w-4 rounded border-gray-300 text-teal-600 focus:ring-teal-500" checked>
                                                <span class="text-sm text-slate-700">Vận dụng</span>
                                                <span class="text-xs text-slate-500 ml-1" id="count-difficulty-van_dung">(0)</span>
                                            </label>
                                        </div>
                                    </div>
                                </div>
                                <div id="question-count-wrapper-comprehensive" class="mt-6 space-y-2 hidden">
                                     <label for="question-count-comprehensive" class="text-sm font-medium text-slate-700">Tổng số câu hỏi:</label>
                                    <div class="flex items-center space-x-4">
                                        <input id="question-count-slider-comprehensive" type="range" min="10" max="50" value="20" class="w-full h-2 bg-slate-200 rounded-lg appearance-none cursor-pointer">
                                        <span id="question-count-label-comprehensive" class="font-bold text-slate-800 w-12 text-center">20</span>
                                    </div>
                                </div>
                                <div class="mt-6 flex justify-end">
                                     <button id="start-comprehensive-practice-btn" class="cta-button text-white font-bold px-8 py-3 rounded-lg disabled:bg-slate-400 disabled:cursor-not-allowed" disabled>
                                        Bắt đầu (0 câu)
                                    </button>
                                </div>
                            </div>
                        </div>

                    </div>
                </div>
            </div>
        </main>
    </main>

     <div id="toast-container" class="fixed bottom-5 right-5 z-50 space-y-2"></div>

    <script src="../firebase-config.js"></script>
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, collection, getDocs, query, where } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        document.addEventListener('DOMContentLoaded', () => {
            const app = initializeApp(firebaseConfig);
            const auth = getAuth(app);
            const db = getFirestore(app);

            const userNameEl = document.getElementById('user-name');
            const userAvatarEl = document.getElementById('user-avatar');
            const toastContainer = document.getElementById('toast-container');
            const tabsContainer = document.getElementById('tabs-container');
            const tabContents = document.querySelectorAll('.tab-content');
            
            const aiPracticeContent = document.getElementById('ai-practice-content');
            const adminTestsContainer = document.getElementById('admin-tests-container');
            
            const filtersLesson = { subject: document.getElementById('filter-subject-lesson'), grade: document.getElementById('filter-grade-lesson') };
            const lessonListContainerLesson = document.getElementById('lesson-list-container-lesson');
            const questionCountWrapperLesson = document.getElementById('question-count-wrapper-lesson');
            const questionCountSliderLesson = document.getElementById('question-count-slider-lesson');
            const questionCountLabelLesson = document.getElementById('question-count-label-lesson');
            const startLessonPracticeBtn = document.getElementById('start-lesson-practice-btn');

            const filtersComp = { subject: document.getElementById('filter-subject-comprehensive'), grade: document.getElementById('filter-grade-comprehensive') };
            const lessonListContainerComp = document.getElementById('lesson-list-container-comprehensive');
            const startCompPracticeBtn = document.getElementById('start-comprehensive-practice-btn');
            const questionCountWrapperComp = document.getElementById('question-count-wrapper-comprehensive');
            const questionCountSliderComp = document.getElementById('question-count-slider-comprehensive');
            const questionCountLabelComp = document.getElementById('question-count-label-comprehensive');

            let currentUser = null;
            let userData = {};
            let allDataCache = {
                subjects: [], lessons: [], tests: [], submissions: [], questions: [], users: []
            };

            function cleanPrefix(text) {
                if (!text) return '';
                return text.replace(/^(Câu|Bài|Phần|Mục)\s*\d+\s*[:.]?\s*/i, '').trim();
            }

            onAuthStateChanged(auth, async (user) => {
                if (user) {
                    currentUser = user;
                    const docSnap = await getDoc(doc(db, "users", user.uid));
                    if (docSnap.exists() && docSnap.data().role === 'student') {
                        userData = docSnap.data();
                        userNameEl.textContent = userData.name || 'Học sinh';
                        const nameInitial = (userData.name || 'S').charAt(0).toUpperCase();
                        userAvatarEl.src = `https://placehold.co/40x40/10B981/FFFFFF?text=${nameInitial}`;
                        
                        if (!userData.grade) {
                           document.querySelector('main.flex-1').innerHTML = `<div class="p-8"><div class="bg-white p-6 rounded-xl shadow-sm text-center"><p class="text-slate-500">Vui lòng vào trang <a href="account.html" class="font-bold text-teal-600 hover:underline">Tài khoản</a> để chọn khối lớp của bạn trước khi luyện đề.</p></div></div>`;
                        } else {
                            await loadInitialData();
                            initializeTabs();
                        }
                    } else {
                       window.location.href = `../${docSnap.data()?.role || 'auth'}/index.html`;
                    }
                } else {
                    window.location.href = '../auth.html';
                }
            });

            async function loadInitialData() {
                try {
                    if (!currentUser) return; 
                    const [subjectsSnap, lessonsSnap, testsSnap, submissionsSnap, questionsSnap, usersSnap] = await Promise.all([
                        getDocs(collection(db, "subjects")),
                        getDocs(collection(db, "lessons")),
                        getDocs(query(collection(db, "tests"), where("status", "==", "published"))),
                        getDocs(query(collection(db, "submissions"), where("studentId", "==", currentUser.uid))),
                        getDocs(query(collection(db, "questions"), where("status", "==", "approved"))),
                        getDocs(collection(db, "users"))
                    ]);
                    allDataCache.subjects = subjectsSnap.docs.map(d => ({id: d.id, ...d.data()}));
                    allDataCache.lessons = lessonsSnap.docs.map(d => ({id: d.id, ...d.data()}));
                    allDataCache.tests = testsSnap.docs.map(d => ({id: d.id, ...d.data()}));
                    allDataCache.submissions = submissionsSnap.docs.map(d => ({id: d.id, ...d.data()}));
                    allDataCache.questions = questionsSnap.docs.map(d => ({id: d.id, ...d.data()}));
                    allDataCache.users = usersSnap.docs.map(d => ({id: d.id, ...d.data()}));
                } catch (error) {
                    console.error("Error loading initial data:", error);
                    showToast("Lỗi tải dữ liệu. Vui lòng thử lại.", "error");
                }
            }
            
            function initializeTabs() {
                setupEventListeners();
                loadAiPracticeTab(); 
                feather.replace();
            }

            async function loadAiPracticeTab() {
                aiPracticeContent.innerHTML = `<div class="skeleton h-20 w-full"></div>`;
                const incorrectQuestions = (allDataCache.submissions || []).flatMap(r => r.incorrectQuestions || []);
                if (incorrectQuestions.length === 0) {
                    aiPracticeContent.innerHTML = `<div class="text-center"><i data-feather="award" class="w-16 h-16 mx-auto text-green-500"></i><p class="mt-4 font-semibold text-slate-700">Tuyệt vời!</p><p class="mt-1 text-slate-500">Hệ thống không ghi nhận lỗi sai nào gần đây.</p></div>`;
                    feather.replace(); return;
                }
                const weakLessonsBySubject = {};
                incorrectQuestions.forEach(q => {
                    if (q.lessonId) {
                        const lesson = allDataCache.lessons.find(l => l.id === q.lessonId);
                        if (lesson && lesson.subjectId) {
                            if (!weakLessonsBySubject[lesson.subjectId]) weakLessonsBySubject[lesson.subjectId] = new Set();
                            weakLessonsBySubject[lesson.subjectId].add(q.lessonId);
                        }
                    }
                });
                if (Object.keys(weakLessonsBySubject).length === 0) {
                    aiPracticeContent.innerHTML = `<p class="mt-1 text-slate-500 text-center">Không tìm thấy chủ đề cần ôn tập.</p>`;
                    return;
                }
                aiPracticeContent.innerHTML = '<h3 class="text-lg font-semibold text-left mb-4 text-slate-700">Chọn môn học để ôn tập kiến thức yếu:</h3>';
                const container = document.createElement('div');
                container.className = 'space-y-3';
                for (const subjectId in weakLessonsBySubject) {
                    const subject = allDataCache.subjects.find(s => s.id === subjectId);
                    const lessonIds = Array.from(weakLessonsBySubject[subjectId]);
                    const questionPool = allDataCache.questions.filter(q => lessonIds.includes(q.lessonId)).map(q => q.id);
                    if (subject && questionPool.length > 0) {
                        const card = document.createElement('div');
                        card.className = 'p-4 border rounded-lg bg-slate-50 flex justify-between items-center';
                        card.innerHTML = `<div><p class="font-bold text-slate-800">${subject.name}</p><p class="text-sm text-slate-500">${lessonIds.length} chủ đề cần củng cố.</p></div>
                                          <button data-subject-id="${subjectId}" data-question-ids='${JSON.stringify(questionPool)}' class="generate-ai-test-btn cta-button text-white font-bold px-5 py-2 rounded-lg">Tạo đề (${Math.min(20, questionPool.length)} câu)</button>`;
                        container.appendChild(card);
                    }
                }
                aiPracticeContent.appendChild(container);
            }

            function loadAdminPracticeTab() {
                const adminUsers = allDataCache.users.filter(u => u.role === 'admin');
                const adminIds = adminUsers.map(u => u.id);
                const adminTests = allDataCache.tests.filter(t => adminIds.includes(t.authorId));
                if (adminTests.length === 0) {
                    adminTestsContainer.innerHTML = `<div class="text-center p-4"><p class="text-slate-500">Hiện chưa có đề luyện tập nào.</p></div>`;
                    return;
                }
                renderTestsList(adminTests, adminTestsContainer);
            }
            
            function loadLessonPracticeTab() { populateSelect(filtersLesson.subject, allDataCache.subjects, 'Chọn Môn học'); }
            function loadComprehensivePracticeTab() { populateSelect(filtersComp.subject, allDataCache.subjects, 'Chọn Môn học'); }

            function renderLessonList(container, subjectId, grade, inputType) {
                const lessons = allDataCache.lessons.filter(l => l.subjectId === subjectId && l.grade == grade).sort((a, b) => (a.order ?? Infinity) - (b.order ?? Infinity));
                if (lessons.length === 0) {
                    container.innerHTML = '<p class="text-slate-500">Không tìm thấy bài học nào cho lựa chọn này.</p>';
                    container.classList.remove('grid');
                    return;
                }
                container.innerHTML = '';
                container.className = 'grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4 text-left max-h-80 overflow-y-auto p-2';
                
                lessons.forEach(lesson => {
                    const questionCount = allDataCache.questions.filter(q => q.lessonId === lesson.id).length;
                    const card = document.createElement('div');
                    card.className = `relative lesson-card rounded-lg border transition-all duration-200 ${questionCount === 0 ? 'bg-slate-100 cursor-not-allowed opacity-70' : 'bg-white hover:border-teal-400 hover:shadow-md'}`;
                    
                    card.innerHTML = `
                        <input id="${lesson.id}-${inputType}" type="${inputType}" data-lesson-id="${lesson.id}" name="lesson-selection-${inputType}" class="sr-only peer" ${questionCount === 0 ? 'disabled' : ''}>
                        <label for="${lesson.id}-${inputType}" class="block p-4 cursor-pointer">
                            <div class="flex items-start justify-between">
                                <span class="text-xs font-bold ${questionCount === 0 ? 'bg-slate-200 text-slate-500' : 'bg-teal-100 text-teal-800'} px-2 py-1 rounded-full">${questionCount} câu</span>
                                <div class="w-6 h-6 flex items-center justify-center rounded-full bg-teal-500 text-white lesson-check-icon">
                                    <i data-feather="check" class="w-4 h-4"></i>
                                </div>
                            </div>
                            <span class="block mt-3 font-semibold ${questionCount === 0 ? 'text-slate-400' : 'text-slate-800'}">${cleanPrefix(lesson.name)}</span>
                        </label>
                    `;
                    container.appendChild(card);
                });
                feather.replace();
            }

            function updateLessonPracticeState() {
                const selectedRadio = lessonListContainerLesson.querySelector('input[type="radio"]:checked');
                if (!selectedRadio) {
                    questionCountWrapperLesson.classList.add('hidden');
                    startLessonPracticeBtn.disabled = true; return;
                }
                const selectedLessonId = selectedRadio.dataset.lessonId;
                const availableQuestions = allDataCache.questions.filter(q => q.lessonId === selectedLessonId).length;
                
                questionCountWrapperLesson.classList.remove('hidden');
                questionCountSliderLesson.max = Math.min(50, availableQuestions);
                if (parseInt(questionCountSliderLesson.value) > availableQuestions) {
                    questionCountSliderLesson.value = availableQuestions;
                }
                questionCountLabelLesson.textContent = questionCountSliderLesson.value;
                startLessonPracticeBtn.disabled = availableQuestions === 0 || parseInt(questionCountSliderLesson.value) === 0;
            }

            function updateComprehensivePracticeState() {
                const selectedCheckboxes = lessonListContainerComp.querySelectorAll('input[type="checkbox"]:checked');
                const filterOptionsWrapper = document.getElementById('filter-options-wrapper-comprehensive');
                
                if (selectedCheckboxes.length === 0) {
                    filterOptionsWrapper.classList.add('hidden');
                    questionCountWrapperComp.classList.add('hidden');
                    startCompPracticeBtn.disabled = true;
                    startCompPracticeBtn.textContent = `Bắt đầu (0 câu)`; 
                    return;
                }

                const selectedLessonIds = Array.from(selectedCheckboxes).map(cb => cb.dataset.lessonId);
                const lessonQuestionPool = allDataCache.questions.filter(q => selectedLessonIds.includes(q.lessonId));

                // --- UPDATE COUNTS FOR FILTER OPTIONS ---
                const types = ['multiple_choice', 'true_false_group', 'short_answer'];
                types.forEach(type => {
                    let count = 0;
                    if (type === 'true_false_group') {
                        count = lessonQuestionPool.filter(q => q.type === 'true_false' || q.type === 'true_false_group').length;
                    } else {
                        count = lessonQuestionPool.filter(q => q.type === type).length;
                    }
                    const countElement = document.getElementById(`count-type-${type}`);
                    if(countElement) countElement.textContent = `(${count})`;
                });

                const difficulties = ['nhan_biet', 'thong_hieu', 'van_dung'];
                difficulties.forEach(difficulty => {
                    const count = lessonQuestionPool.filter(q => q.difficulty === difficulty).length;
                    const countElement = document.getElementById(`count-difficulty-${difficulty}`);
                    if(countElement) countElement.textContent = `(${count})`;
                });

                const selectedTypes = Array.from(document.querySelectorAll('#comprehensive-practice input[name="question-type"]:checked')).map(cb => cb.value);
                const selectedDifficulties = Array.from(document.querySelectorAll('#comprehensive-practice input[name="question-difficulty"]:checked')).map(cb => cb.value);

                const availableQuestions = lessonQuestionPool.filter(q => {
                    const isTfTypeSelected = selectedTypes.includes('true_false_group');
                    const typeMatch = selectedTypes.includes(q.type) || (isTfTypeSelected && (q.type === 'true_false' || q.type === 'true_false_group'));
                    const difficultyMatch = selectedDifficulties.length === 0 ? true : selectedDifficulties.includes(q.difficulty);
                    return typeMatch && difficultyMatch;
                }).length;
                
                filterOptionsWrapper.classList.remove('hidden');
                questionCountWrapperComp.classList.remove('hidden');
                
                questionCountSliderComp.max = Math.min(50, availableQuestions);
                if (parseInt(questionCountSliderComp.value) > availableQuestions) {
                     questionCountSliderComp.value = availableQuestions;
                }
                if (availableQuestions > 0 && parseInt(questionCountSliderComp.value) === 0) {
                    questionCountSliderComp.value = Math.min(20, availableQuestions);
                }
                questionCountLabelComp.textContent = questionCountSliderComp.value;
                startCompPracticeBtn.disabled = availableQuestions === 0 || parseInt(questionCountSliderComp.value) === 0;
                startCompPracticeBtn.textContent = `Bắt đầu (${availableQuestions} câu)`;
            }

            function handleStartLessonPractice() {
                const selectedRadio = lessonListContainerLesson.querySelector('input[type="radio"]:checked');
                if (!selectedRadio) return;
                const lessonId = selectedRadio.dataset.lessonId;
                const questionCount = parseInt(questionCountSliderLesson.value, 10);
                if (questionCount === 0) {
                    showToast("Vui lòng chọn số lượng câu hỏi lớn hơn 0.", "error");
                    return;
                }
                // Luyện theo bài sẽ trộn tất cả các dạng câu hỏi
                const questionPool = allDataCache.questions.filter(q => q.lessonId === lessonId).map(q => q.id);
                
                const finalQuestionIds = questionPool.sort(() => 0.5 - Math.random()).slice(0, questionCount);
                sessionStorage.setItem('practiceTestQuestions', JSON.stringify(finalQuestionIds));
                sessionStorage.setItem('practiceContext', JSON.stringify({ type: 'lesson_practice', subjectId: filtersLesson.subject.value }));
                window.location.href = 'practice-test.html';
            }

            function handleStartComprehensivePractice() {
                const selectedCheckboxes = lessonListContainerComp.querySelectorAll('input[type="checkbox"]:checked');
                if (selectedCheckboxes.length === 0) return;
                const selectedLessonIds = Array.from(selectedCheckboxes).map(cb => cb.dataset.lessonId);
                const totalQuestionCount = parseInt(questionCountSliderComp.value, 10);
                if (totalQuestionCount === 0) {
                    showToast("Vui lòng chọn số lượng câu hỏi lớn hơn 0.", "error");
                    return;
                }
                
                const selectedTypes = Array.from(document.querySelectorAll('#comprehensive-practice input[name="question-type"]:checked')).map(cb => cb.value);
                const selectedDifficulties = Array.from(document.querySelectorAll('#comprehensive-practice input[name="question-difficulty"]:checked')).map(cb => cb.value);

                if(selectedTypes.length === 0) {
                    showToast("Vui lòng chọn ít nhất một dạng thức câu hỏi.", "error");
                    return;
                }
                if(selectedDifficulties.length === 0) {
                    showToast("Vui lòng chọn ít nhất một mức độ nhận thức.", "error");
                    return;
                }
                
                // Luyện tổng hợp sẽ lọc theo các dạng đã chọn
                const questionPool = allDataCache.questions.filter(q => {
                    const isTfTypeSelected = selectedTypes.includes('true_false_group');
                    const typeMatch = selectedTypes.includes(q.type) || (isTfTypeSelected && (q.type === 'true_false' || q.type === 'true_false_group'));
                    const difficultyMatch = selectedDifficulties.includes(q.difficulty);
                    const lessonMatch = selectedLessonIds.includes(q.lessonId);
                    return lessonMatch && typeMatch && difficultyMatch;
                });
                
                const finalQuestions = questionPool.sort(() => 0.5 - Math.random()).slice(0, totalQuestionCount).map(q => q.id);

                if (finalQuestions.length === 0) {
                    showToast("Không tìm thấy câu hỏi phù hợp với lựa chọn của bạn.", "error"); return;
                }

                sessionStorage.setItem('practiceTestQuestions', JSON.stringify(finalQuestions));
                sessionStorage.setItem('practiceContext', JSON.stringify({ type: 'comprehensive_practice', subjectId: filtersComp.subject.value }));
                window.location.href = 'practice-test.html';
            }

            function setupEventListeners() {
                document.getElementById('logout-btn').addEventListener('click', () => signOut(auth));
                document.querySelectorAll('.nav-link').forEach(link => {
                    link.onclick = (e) => { e.preventDefault(); document.body.style.opacity = '0'; setTimeout(() => window.location.href = link.href, 200); };
                });
                document.body.style.transition = 'opacity 0.2s ease-in-out';
                
                tabsContainer.addEventListener('click', (e) => {
                    const button = e.target.closest('.tab-button');
                    if (!button) return;
                    tabsContainer.querySelectorAll('.tab-button').forEach(btn => btn.classList.remove('active'));
                    tabContents.forEach(content => content.classList.remove('active'));
                    button.classList.add('active');
                    const tabId = button.dataset.tab;
                    document.getElementById(tabId).classList.add('active');
                    if (tabId === 'ai-practice') loadAiPracticeTab();
                    else if (tabId === 'admin-practice') loadAdminPracticeTab();
                    else if (tabId === 'lesson-practice') loadLessonPracticeTab();
                    else if (tabId === 'comprehensive-practice') loadComprehensivePracticeTab();
                });
                
                aiPracticeContent.addEventListener('click', (e) => {
                    const button = e.target.closest('.generate-ai-test-btn');
                    if (button) {
                        const subjectId = button.dataset.subjectId;
                        const questionPool = JSON.parse(button.dataset.questionIds);
                        const finalQuestionIds = questionPool.sort(() => 0.5 - Math.random()).slice(0, 20);
                        sessionStorage.setItem('practiceTestQuestions', JSON.stringify(finalQuestionIds));
                        sessionStorage.setItem('practiceContext', JSON.stringify({ type: 'ai_generated', subjectId: subjectId }));
                        window.location.href = 'practice-test.html';
                    }
                });

                adminTestsContainer.addEventListener('click', (e) => {
                    const viewResultBtn = e.target.closest('.view-result-btn');
                    if (viewResultBtn) {
                        e.preventDefault();
                        sessionStorage.setItem('latestResultId', viewResultBtn.dataset.submissionId);
                        window.location.href = viewResultBtn.href;
                    }
                });
                
                function handleSubjectChangeLesson() {
                    const subjectId = filtersLesson.subject.value;
                    populateGrades(filtersLesson, subjectId);
                    handleGradeChangeLesson();
                }
                function handleGradeChangeLesson() {
                    const subjectId = filtersLesson.subject.value;
                    const grade = parseInt(filtersLesson.grade.value, 10);
                    if (subjectId && grade) {
                        renderLessonList(lessonListContainerLesson, subjectId, grade, 'radio');
                    } else {
                        lessonListContainerLesson.innerHTML = '<p class="text-slate-500">Vui lòng chọn một Lớp.</p>';
                        lessonListContainerLesson.className = 'mt-4 text-center text-slate-500 p-6 bg-slate-50 rounded-lg';
                    }
                    updateLessonPracticeState();
                }
                function handleSubjectChangeComp() {
                    const subjectId = filtersComp.subject.value;
                    populateGrades(filtersComp, subjectId);
                    handleGradeChangeComp();
                }
                function handleGradeChangeComp() {
                    const subjectId = filtersComp.subject.value;
                    const grade = parseInt(filtersComp.grade.value, 10);
                    if (subjectId && grade) {
                        renderLessonList(lessonListContainerComp, subjectId, grade, 'checkbox');
                    } else {
                        lessonListContainerComp.innerHTML = '<p class="text-slate-500">Vui lòng chọn một Lớp.</p>';
                        lessonListContainerComp.className = 'mt-4 text-center text-slate-500 p-6 bg-slate-50 rounded-lg';
                    }
                    updateComprehensivePracticeState();
                }

                filtersLesson.subject.onchange = handleSubjectChangeLesson;
                filtersLesson.grade.onchange = handleGradeChangeLesson;
                lessonListContainerLesson.onchange = updateLessonPracticeState;
                questionCountSliderLesson.oninput = (e) => {
                    questionCountLabelLesson.textContent = e.target.value;
                    updateLessonPracticeState();
                };
                startLessonPracticeBtn.onclick = handleStartLessonPractice;

                filtersComp.subject.onchange = handleSubjectChangeComp;
                filtersComp.grade.onchange = handleGradeChangeComp;
                lessonListContainerComp.onchange = updateComprehensivePracticeState;
                document.getElementById('comprehensive-practice').addEventListener('change', (e) => {
                    if (e.target.name === 'question-type' || e.target.name === 'question-difficulty') {
                        updateComprehensivePracticeState();
                    }
                });
                questionCountSliderComp.oninput = (e) => {
                    questionCountLabelComp.textContent = e.target.value;
                    updateComprehensivePracticeState();
                };
                startCompPracticeBtn.onclick = handleStartComprehensivePractice;
            }

            function populateGrades(filterGroup, subjectId) {
                const gradeSelect = filterGroup.grade;
                const gradeOptions = [...new Set(allDataCache.lessons.filter(l => l.subjectId === subjectId).map(l => l.grade))].sort((a, b) => a - b);
                populateSelect(gradeSelect, gradeOptions.map(g => ({ id: g, name: `Lớp ${g}` })), 'Chọn Lớp');
                gradeSelect.disabled = !subjectId;
                gradeSelect.value = userData.grade || '';
                gradeSelect.dispatchEvent(new Event('change'));
            }
            
            function renderTestsList(tests, container) {
                if (tests.length === 0) {
                    container.innerHTML = `<div class="text-center p-4"><p class="text-slate-500">Không có đề thi nào trong mục này.</p></div>`;
                    return;
                }
                container.innerHTML = '';
                tests.forEach(test => {
                    const subject = allDataCache.subjects.find(s => s.id === test.subjectId);
                    const submissionKey = `practice_admin_${test.id}`;
                    const submission = allDataCache.submissions.find(s => s.id.startsWith(submissionKey) || (s.testId === test.id && s.classId === undefined));
                    
                    const card = document.createElement('div');
                    card.className = "bg-white p-6 rounded-xl shadow-sm flex items-center justify-between";
                    
                    let buttonHTML = submission 
                        ? `<a href="result.html" data-submission-id="${submission.id}" class="view-result-btn bg-white text-slate-700 font-semibold px-5 py-2 rounded-lg border border-slate-300 hover:bg-slate-50 transition">Xem kết quả</a>`
                        : `<a href="practice-test.html?testId=${test.id}" class="cta-button text-white font-semibold px-5 py-2 rounded-lg">Làm bài</a>`;

                    card.innerHTML = `
                        <div>
                            <h3 class="font-bold text-lg text-slate-800">${test.name}</h3>
                            <p class="text-sm text-slate-500 mt-1">${subject?.name || ''} - ${test.questionIds?.length || 0} câu</p>
                        </div>
                        <div>${buttonHTML}</div>`;
                    container.appendChild(card);
                });
            }

            function populateSelect(selectElement, data, placeholder) {
                selectElement.innerHTML = `<option value="">${placeholder}</option>`;
                (data || []).forEach(item => {
                    selectElement.innerHTML += `<option value="${item.id || item.value}">${item.name}</option>`;
                });
            }

            function showToast(message, type = 'error') {
                const toast = document.createElement('div');
                const bgColor = type === 'success' ? 'bg-green-500' : 'bg-red-500';
                toast.className = `toast show ${bgColor} text-white px-4 py-2 rounded-lg shadow-lg`;
                toast.textContent = message;
                toastContainer.appendChild(toast);
                setTimeout(() => {
                    toast.classList.remove('show');
                    toast.addEventListener('transitionend', () => toast.remove());
                }, 3000);
            }
        });
    </script>
</body>
</html>

